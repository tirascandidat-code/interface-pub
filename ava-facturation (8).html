<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVA Facturation</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --apple-blue: #007AFF;
            --apple-blue-dark: #0056CC;
            --apple-green: #34C759;
            --apple-orange: #FF9500;
            --apple-red: #FF3B30;
            --apple-purple: #AF52DE;
            --apple-gray-1: #8E8E93;
            --apple-gray-2: #AEAEB2;
            --apple-gray-3: #C7C7CC;
            --apple-gray-4: #D1D1D6;
            --apple-gray-5: #E5E5EA;
            --apple-gray-6: #F2F2F7;
            --apple-bg: #FBFBFD;
            --apple-card: rgba(255, 255, 255, 0.8);
            --apple-sidebar: rgba(255, 255, 255, 0.72);
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.12);
            --blur: blur(20px);
            --transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        /* Dark Mode */
        [data-theme="dark"] {
            --apple-gray-1: #98989D;
            --apple-gray-2: #636366;
            --apple-gray-3: #48484A;
            --apple-gray-4: #3A3A3C;
            --apple-gray-5: #2C2C2E;
            --apple-gray-6: #1C1C1E;
            --apple-bg: #000000;
            --apple-card: rgba(28, 28, 30, 0.8);
            --apple-sidebar: rgba(28, 28, 30, 0.72);
            --text-primary: #FFFFFF;
            --text-secondary: #98989D;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.5);
        }

        [data-theme="dark"] .login-container {
            background: #1C1C1E;
        }

        [data-theme="dark"] .login-input {
            background: #2C2C2E;
            border-color: #3A3A3C;
            color: white;
        }

        [data-theme="dark"] .table th {
            background: #2C2C2E;
        }

        [data-theme="dark"] .table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        [data-theme="dark"] .modal {
            background: #1C1C1E;
        }

        [data-theme="dark"] .form-input {
            background: #2C2C2E;
            border-color: #3A3A3C;
            color: white;
        }

        [data-theme="dark"] .form-input:focus {
            border-color: var(--apple-blue);
        }

        [data-theme="dark"] .btn-secondary {
            background: #3A3A3C;
            color: white;
        }

        [data-theme="dark"] .preview-panel {
            background: #1C1C1E;
        }

        [data-theme="dark"] .preview-document {
            background: #2C2C2E;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--apple-bg);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ========== ANIMATIONS ========== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ========== LOGIN SCREEN ========== */
        .login-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-container {
            background: white;
            border-radius: 24px;
            padding: 48px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: scaleIn 0.4s ease;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo-icon {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, var(--apple-blue), var(--apple-purple));
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 32px;
            font-weight: 800;
            color: white;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
        }

        .login-form {
            margin-top: 32px;
        }

        .login-input-group {
            margin-bottom: 20px;
        }

        .login-input-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--apple-gray-4);
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            transition: var(--transition);
        }

        .login-input:focus {
            outline: none;
            border-color: var(--apple-blue);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--apple-blue), var(--apple-purple));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 8px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 122, 255, 0.35);
        }

        .login-error {
            background: rgba(255, 59, 48, 0.1);
            color: var(--apple-red);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
            display: none;
        }

        .login-error.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--apple-gray-6);
            border-radius: 12px;
            margin: 16px;
            margin-top: auto;
        }

        .user-badge-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--apple-blue), var(--apple-purple));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-badge-info {
            flex: 1;
        }

        .user-badge-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .user-badge-role {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .user-badge-logout {
            background: none;
            border: none;
            color: var(--apple-red);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: var(--transition);
        }

        .user-badge-logout:hover {
            background: rgba(255, 59, 48, 0.1);
        }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            margin: 0 16px 8px;
            background: var(--apple-gray-6);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: var(--apple-gray-5);
        }

        .theme-toggle-track {
            width: 44px;
            height: 24px;
            background: var(--apple-gray-3);
            border-radius: 12px;
            position: relative;
            transition: var(--transition);
        }

        .theme-toggle-track.active {
            background: var(--apple-blue);
        }

        .theme-toggle-thumb {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .theme-toggle-track.active .theme-toggle-thumb {
            left: 22px;
        }

        .theme-toggle-label {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Global Search */
        .global-search {
            position: relative;
            margin: 0 16px 16px;
        }

        .global-search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 1px solid var(--apple-gray-4);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            background: var(--apple-gray-6);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .global-search-input:focus {
            outline: none;
            border-color: var(--apple-blue);
            background: var(--apple-card);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .global-search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .global-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--apple-card);
            backdrop-filter: var(--blur);
            border: 1px solid var(--apple-gray-4);
            border-radius: 12px;
            margin-top: 8px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            display: none;
        }

        .global-search-results.show {
            display: block;
        }

        .search-result-group {
            padding: 8px 0;
            border-bottom: 1px solid var(--apple-gray-5);
        }

        .search-result-group:last-child {
            border-bottom: none;
        }

        .search-result-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            padding: 4px 16px;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            cursor: pointer;
            transition: var(--transition);
        }

        .search-result-item:hover {
            background: var(--apple-gray-6);
        }

        .search-result-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-name {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
        }

        .search-result-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Dashboard Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--apple-card);
            backdrop-filter: var(--blur);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-container {
            position: relative;
            height: 200px;
        }

        .chart-bar-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 160px;
            padding-top: 20px;
        }

        .chart-bar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 50px;
        }

        .chart-bar {
            width: 24px;
            background: linear-gradient(to top, var(--apple-blue), var(--apple-purple));
            border-radius: 6px 6px 0 0;
            min-height: 4px;
            transition: var(--transition);
        }

        .chart-bar:hover {
            opacity: 0.8;
        }

        .chart-bar-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .chart-bar-value {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        /* Donut Chart */
        .donut-chart {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .donut-svg {
            width: 120px;
            height: 120px;
            transform: rotate(-90deg);
        }

        .donut-segment {
            fill: none;
            stroke-width: 20;
            transition: var(--transition);
        }

        .donut-segment:hover {
            opacity: 0.8;
        }

        .donut-legend {
            flex: 1;
        }

        .donut-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .donut-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .donut-legend-label {
            flex: 1;
            color: var(--text-secondary);
        }

        .donut-legend-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Recurring Invoice Badge */
        .recurring-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(175, 82, 222, 0.1);
            color: var(--apple-purple);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
        }

        /* Calendar Styles */
        .calendar-container {
            padding: 16px;
        }

        .calendar-header-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .calendar-header-cell {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 8px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            aspect-ratio: 1;
            min-height: 80px;
            padding: 8px;
            background: var(--apple-gray-6);
            border-radius: 8px;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar-day:hover {
            background: var(--apple-gray-5);
        }

        .calendar-day.other-month {
            opacity: 0.4;
        }

        .calendar-day.today {
            background: rgba(0, 122, 255, 0.1);
            border: 2px solid var(--apple-blue);
        }

        .calendar-day-number {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .calendar-day.today .calendar-day-number {
            color: var(--apple-blue);
        }

        .calendar-events {
            margin-top: 4px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }

        .calendar-event {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar-event.invoice-due {
            background: rgba(255, 149, 0, 0.2);
            color: var(--apple-orange);
        }

        .calendar-event.invoice-late {
            background: rgba(255, 59, 48, 0.2);
            color: var(--apple-red);
        }

        .calendar-event.prospect-action {
            background: rgba(175, 82, 222, 0.2);
            color: var(--apple-purple);
        }

        .calendar-event.quote-expiry {
            background: rgba(0, 122, 255, 0.2);
            color: var(--apple-blue);
        }

        .upcoming-event-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            background: var(--apple-gray-6);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .upcoming-event-date {
            text-align: center;
            min-width: 50px;
        }

        .upcoming-event-day {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .upcoming-event-month {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .upcoming-event-info {
            flex: 1;
        }

        .upcoming-event-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .upcoming-event-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .upcoming-event-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Phone/Call Styles */
        .phone-dialer {
            background: var(--apple-card);
            border-radius: 16px;
            padding: 24px;
            max-width: 320px;
            margin: 0 auto;
        }

        .phone-display {
            background: var(--apple-gray-6);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-bottom: 16px;
        }

        .phone-number {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 2px;
            min-height: 40px;
        }

        .phone-contact-name {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .phone-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .phone-key {
            aspect-ratio: 1;
            border: none;
            background: var(--apple-gray-6);
            border-radius: 50%;
            font-size: 24px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .phone-key:hover {
            background: var(--apple-gray-5);
        }

        .phone-key:active {
            transform: scale(0.95);
        }

        .phone-key-sub {
            font-size: 9px;
            color: var(--text-secondary);
            letter-spacing: 1px;
        }

        .phone-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        .phone-call-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .phone-call-btn.call {
            background: var(--apple-green);
            color: white;
        }

        .phone-call-btn.whatsapp {
            background: #25D366;
            color: white;
        }

        .phone-call-btn.end {
            background: var(--apple-red);
            color: white;
        }

        .phone-call-btn:hover {
            transform: scale(1.1);
        }

        .call-log-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            transition: var(--transition);
            cursor: pointer;
        }

        .call-log-item:hover {
            background: var(--apple-gray-6);
        }

        .call-log-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--apple-blue), var(--apple-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .call-log-info {
            flex: 1;
        }

        .call-log-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .call-log-number {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .call-log-meta {
            text-align: right;
        }

        .call-log-time {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .call-log-type {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            margin-top: 2px;
        }

        .call-log-type.outgoing {
            color: var(--apple-green);
        }

        .call-log-type.incoming {
            color: var(--apple-blue);
        }

        .call-log-type.missed {
            color: var(--apple-red);
        }

        .quick-call-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-call-btn.phone {
            background: rgba(52, 199, 89, 0.1);
            color: var(--apple-green);
        }

        .quick-call-btn.whatsapp {
            background: rgba(37, 211, 102, 0.1);
            color: #25D366;
        }

        .quick-call-btn:hover {
            transform: scale(1.1);
        }

        .contact-actions {
            display: flex;
            gap: 8px;
        }

        /* Developer Panel Styles */
        .dev-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .dev-panel-overlay.active {
            display: flex;
        }

        .dev-panel {
            background: var(--apple-card);
            backdrop-filter: var(--blur);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: scaleIn 0.3s ease;
        }

        .dev-panel-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--apple-gray-5);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dev-panel-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dev-panel-title svg {
            color: var(--apple-purple);
        }

        .dev-panel-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--apple-gray-6);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .dev-panel-close:hover {
            background: var(--apple-gray-5);
            color: var(--text-primary);
        }

        .dev-panel-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(80vh - 80px);
        }

        .dev-section {
            margin-bottom: 24px;
        }

        .dev-section:last-child {
            margin-bottom: 0;
        }

        .dev-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .module-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--apple-gray-6);
            border-radius: 12px;
            margin-bottom: 12px;
            transition: var(--transition);
        }

        .module-item:last-child {
            margin-bottom: 0;
        }

        .module-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .module-info {
            flex: 1;
        }

        .module-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .module-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .module-toggle {
            position: relative;
            width: 51px;
            height: 31px;
            background: var(--apple-gray-3);
            border-radius: 16px;
            cursor: pointer;
            transition: var(--transition);
        }

        .module-toggle.active {
            background: var(--apple-green);
        }

        .module-toggle-thumb {
            position: absolute;
            width: 27px;
            height: 27px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .module-toggle.active .module-toggle-thumb {
            left: 22px;
        }

        .dev-warning {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 149, 0, 0.1);
            border-radius: 10px;
            margin-bottom: 16px;
        }

        .dev-warning-icon {
            color: var(--apple-orange);
            flex-shrink: 0;
        }

        .dev-warning-text {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .dev-info {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            padding: 16px;
            border-top: 1px solid var(--apple-gray-5);
            margin-top: 16px;
        }

        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes checkmark {
            0% { stroke-dashoffset: 100; }
            100% { stroke-dashoffset: 0; }
        }

        /* ========== LAYOUT ========== */
        .app {
            display: flex;
            min-height: 100vh;
            animation: fadeIn 0.6s ease;
        }

        /* ========== SIDEBAR ========== */
        .sidebar {
            width: 260px;
            background: var(--apple-sidebar);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border-right: 1px solid rgba(0, 0, 0, 0.06);
            padding: 24px 16px;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            margin-bottom: 32px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--apple-blue) 0%, #5856D6 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .logo-text {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .nav {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 12px;
            margin-bottom: 4px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            transition: var(--transition);
            position: relative;
        }

        .nav-item:hover {
            background: rgba(0, 0, 0, 0.04);
        }

        .nav-item.active {
            background: rgba(0, 122, 255, 0.1);
            color: var(--apple-blue);
        }

        .nav-item.active .nav-icon {
            color: var(--apple-blue);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .nav-badge {
            margin-left: auto;
            background: var(--apple-red);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        /* ========== MAIN CONTENT ========== */
        .main {
            flex: 1;
            margin-left: 260px;
            padding: 32px 40px;
            max-width: 1400px;
        }

        .page {
            display: none;
            animation: slideUp 0.4s ease;
        }

        .page.active {
            display: block;
        }

        /* ========== PAGE HEADER ========== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
        }

        .page-title-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .page-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
        }

        /* ========== BUTTONS ========== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: var(--transition);
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--apple-blue);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.25);
        }

        .btn-primary:hover {
            background: var(--apple-blue-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.35);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--apple-gray-6);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--apple-gray-5);
        }

        .btn-success {
            background: var(--apple-green);
            color: white;
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.25);
        }

        .btn-success:hover {
            background: #2db550;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 199, 89, 0.35);
        }

        .btn-ghost {
            background: transparent;
            color: var(--apple-blue);
        }

        .btn-ghost:hover {
            background: rgba(0, 122, 255, 0.1);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 10px;
        }

        .btn svg {
            width: 18px;
            height: 18px;
        }

        /* ========== STATS GRID ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--apple-card);
            backdrop-filter: var(--blur);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--apple-blue), var(--apple-purple));
            opacity: 0;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:nth-child(1) { animation: slideUp 0.4s ease 0.1s both; }
        .stat-card:nth-child(2) { animation: slideUp 0.4s ease 0.15s both; }
        .stat-card:nth-child(3) { animation: slideUp 0.4s ease 0.2s both; }
        .stat-card:nth-child(4) { animation: slideUp 0.4s ease 0.25s both; }

        .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .stat-icon.blue { background: rgba(0, 122, 255, 0.1); color: var(--apple-blue); }
        .stat-icon.orange { background: rgba(255, 149, 0, 0.1); color: var(--apple-orange); }
        .stat-icon.green { background: rgba(52, 199, 89, 0.1); color: var(--apple-green); }
        .stat-icon.red { background: rgba(255, 59, 48, 0.1); color: var(--apple-red); }

        .stat-icon svg {
            width: 22px;
            height: 22px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
            letter-spacing: -1px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .stat-change.up {
            background: rgba(52, 199, 89, 0.1);
            color: var(--apple-green);
        }

        .stat-change.down {
            background: rgba(255, 59, 48, 0.1);
            color: var(--apple-red);
        }

        /* ========== CARDS ========== */
        .card {
            background: var(--apple-card);
            backdrop-filter: var(--blur);
            border-radius: 20px;
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            animation: slideUp 0.4s ease 0.2s both;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        }

        .card-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-body {
            padding: 0;
        }

        /* ========== TABLE ========== */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            text-align: left;
            padding: 12px 24px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--apple-gray-6);
        }

        .table td {
            padding: 16px 24px;
            font-size: 14px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            transition: var(--transition);
        }

        .table tbody tr {
            transition: var(--transition);
        }

        .table tbody tr:hover {
            background: rgba(0, 122, 255, 0.02);
        }

        .table tbody tr:hover td {
            color: var(--apple-blue);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        .client-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .client-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--apple-blue) 0%, var(--apple-purple) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 13px;
        }

        .client-info {
            display: flex;
            flex-direction: column;
        }

        .client-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .client-email {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ========== BADGES ========== */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(52, 199, 89, 0.12);
            color: var(--apple-green);
        }

        .badge-warning {
            background: rgba(255, 149, 0, 0.12);
            color: var(--apple-orange);
        }

        .badge-danger {
            background: rgba(255, 59, 48, 0.12);
            color: var(--apple-red);
        }

        .badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* ========== ACTION BUTTONS ========== */
        .actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .action-btn:hover {
            background: var(--apple-gray-6);
            color: var(--apple-blue);
        }

        .action-btn.danger:hover {
            background: rgba(255, 59, 48, 0.1);
            color: var(--apple-red);
        }

        .action-btn.email:hover {
            background: rgba(52, 199, 89, 0.1);
            color: var(--apple-green);
        }

        .action-btn svg {
            width: 16px;
            height: 16px;
        }

        /* ========== MODAL ========== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 560px;
            max-height: 90vh;
            overflow: hidden;
            animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--apple-gray-5);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--apple-gray-6);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--apple-gray-5);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px 24px;
            border-top: 1px solid var(--apple-gray-5);
            background: var(--apple-gray-6);
        }

        /* ========== EMAIL INFO CARD ========== */
        .email-info-card {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.1) 0%, rgba(52, 199, 89, 0.1) 100%);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        .email-info-icon {
            width: 44px;
            height: 44px;
            background: var(--apple-blue);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .email-info-icon svg {
            width: 22px;
            height: 22px;
            color: white;
        }

        .email-info-content {
            flex: 1;
        }

        .email-info-title {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .email-info-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ========== FORMS ========== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--apple-gray-4);
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            transition: var(--transition);
            background: white;
        }

        .form-input:hover {
            border-color: var(--apple-gray-3);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--apple-blue);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .form-input::placeholder {
            color: var(--apple-gray-2);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* ========== INVOICE ITEMS ========== */
        .items-container {
            border: 1px solid var(--apple-gray-4);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .items-header {
            display: grid;
            grid-template-columns: 2.5fr 1fr 1fr 1fr auto;
            gap: 12px;
            padding: 12px 16px;
            background: var(--apple-gray-6);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .item-row {
            display: grid;
            grid-template-columns: 2.5fr 1fr 1fr 1fr auto;
            gap: 12px;
            padding: 12px 16px;
            align-items: center;
            border-top: 1px solid var(--apple-gray-5);
            animation: slideIn 0.2s ease;
        }

        .item-row input,
        .item-row select {
            padding: 10px 12px;
            border: 1px solid var(--apple-gray-4);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: var(--transition);
        }

        .item-row input:focus,
        .item-row select:focus {
            outline: none;
            border-color: var(--apple-blue);
        }

        .item-total {
            font-weight: 600;
            color: var(--text-primary);
        }

        .remove-item {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--apple-gray-2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .remove-item:hover {
            background: rgba(255, 59, 48, 0.1);
            color: var(--apple-red);
        }

        .invoice-summary {
            background: var(--apple-gray-6);
            border-radius: 12px;
            padding: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .summary-row.total {
            border-top: 1px solid var(--apple-gray-4);
            margin-top: 8px;
            padding-top: 16px;
            font-size: 18px;
            font-weight: 700;
        }

        .summary-row.total span:last-child {
            color: var(--apple-blue);
        }

        /* ========== PREVIEW ========== */
        .modal-preview {
            max-width: 900px;
        }

        .preview-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: linear-gradient(135deg, #1D1D1F 0%, #2D2D2F 100%);
            color: white;
        }

        .preview-toolbar h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .preview-actions {
            display: flex;
            gap: 12px;
        }

        .preview-content {
            padding: 32px;
            background: var(--apple-gray-6);
            max-height: 70vh;
            overflow-y: auto;
        }

        .invoice-doc {
            background: white;
            border-radius: 16px;
            padding: 48px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: var(--shadow-md);
        }

        .invoice-doc-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 48px;
            padding-bottom: 32px;
            border-bottom: 2px solid var(--apple-gray-5);
        }

        .invoice-doc-brand h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .invoice-doc-brand p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 2px 0;
        }

        .invoice-doc-info {
            text-align: right;
        }

        .invoice-doc-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--apple-blue);
            margin-bottom: 8px;
        }

        .invoice-doc-info p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 4px 0;
        }

        .invoice-doc-parties {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 48px;
            margin-bottom: 48px;
        }

        .invoice-doc-party h4 {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .invoice-doc-party-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .invoice-doc-party p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 2px 0;
        }

        .invoice-doc-table {
            width: 100%;
            margin-bottom: 32px;
            border-collapse: collapse;
        }

        .invoice-doc-table th {
            text-align: left;
            padding: 16px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            background: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .invoice-doc-table th:first-child {
            border-radius: 8px 0 0 8px;
        }

        .invoice-doc-table th:last-child {
            border-radius: 0 8px 8px 0;
            text-align: right;
        }

        .invoice-doc-table td {
            padding: 16px;
            border-bottom: 1px solid var(--apple-gray-5);
            font-size: 14px;
        }

        .invoice-doc-table td:last-child {
            text-align: right;
            font-weight: 600;
        }

        .invoice-doc-totals {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 48px;
        }

        .invoice-doc-totals-table {
            width: 280px;
        }

        .invoice-doc-totals-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .invoice-doc-totals-row.total {
            border-top: 2px solid var(--text-primary);
            margin-top: 8px;
            padding-top: 16px;
            font-size: 20px;
            font-weight: 700;
        }

        .invoice-doc-totals-row.total span:last-child {
            color: var(--apple-blue);
        }

        .invoice-doc-footer {
            padding-top: 32px;
            border-top: 1px solid var(--apple-gray-5);
        }

        .invoice-doc-footer h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .invoice-doc-footer p {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 4px 0;
        }

        .invoice-doc-bank {
            background: var(--apple-gray-6);
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
        }

        /* ========== PAYMENT INFO ========== */
        .payment-status-card {
            border-radius: 12px;
            padding: 20px;
            margin-top: 32px;
        }

        .payment-status-card.paid {
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.1) 0%, rgba(52, 199, 89, 0.05) 100%);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .payment-status-card.pending {
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 149, 0, 0.05) 100%);
            border: 1px solid rgba(255, 149, 0, 0.2);
        }

        .payment-status-card.late {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.1) 0%, rgba(255, 59, 48, 0.05) 100%);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        .payment-status-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .payment-status-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .payment-status-card.paid .payment-status-icon {
            background: rgba(52, 199, 89, 0.2);
            color: var(--apple-green);
        }

        .payment-status-card.pending .payment-status-icon {
            background: rgba(255, 149, 0, 0.2);
            color: var(--apple-orange);
        }

        .payment-status-card.late .payment-status-icon {
            background: rgba(255, 59, 48, 0.2);
            color: var(--apple-red);
        }

        .payment-status-title {
            font-weight: 600;
            font-size: 15px;
        }

        .payment-status-card.paid .payment-status-title { color: var(--apple-green); }
        .payment-status-card.pending .payment-status-title { color: var(--apple-orange); }
        .payment-status-card.late .payment-status-title { color: var(--apple-red); }

        .payment-status-details p {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 4px 0;
        }

        .payment-method-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        /* ========== TOAST ========== */
        .toast {
            position: fixed;
            bottom: 32px;
            right: 32px;
            background: var(--text-primary);
            color: white;
            padding: 16px 24px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-lg);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 2000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--apple-green);
        }

        .toast.error {
            background: var(--apple-red);
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast-icon svg {
            width: 14px;
            height: 14px;
        }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: 64px 32px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: var(--apple-gray-6);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--apple-gray-2);
        }

        .empty-state-icon svg {
            width: 32px;
            height: 32px;
        }

        .empty-state h3 {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
            max-width: 300px;
            margin: 0 auto;
        }

        /* ========== PAYMENT MODAL ========== */
        .payment-info-card {
            background: var(--apple-gray-6);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .payment-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .payment-info-row span:first-child {
            color: var(--text-secondary);
        }

        .payment-info-row span:last-child {
            font-weight: 600;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main {
                margin-left: 0;
                padding: 24px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* ========== PRINT ========== */
        @media print {
            body * { visibility: hidden; }
            .invoice-doc, .invoice-doc * { visibility: visible; }
            .invoice-doc {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <div class="login-logo-icon">A</div>
                <h1 class="login-title">AVA Facturation</h1>
                <p class="login-subtitle">Connectez-vous pour accder  votre espace</p>
            </div>
            <div class="login-error" id="login-error">
                Identifiants incorrects. Veuillez ressayer.
            </div>
            <form class="login-form" id="login-form" onsubmit="handleLogin(event)">
                <div class="login-input-group">
                    <label for="login-username">Identifiant</label>
                    <input type="text" class="login-input" id="login-username" placeholder="Votre identifiant" required autofocus>
                </div>
                <div class="login-input-group">
                    <label for="login-password">Code d'accs</label>
                    <input type="password" class="login-input" id="login-password" placeholder="Votre code" required>
                </div>
                <button type="submit" class="login-btn">Se connecter</button>
            </form>
        </div>
    </div>

    <div class="app" id="app" style="display: none;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon" onclick="handleLogoClick()" style="cursor: pointer;">A</div>
                <span class="logo-text">AVA Facturation</span>
            </div>

            <!-- Global Search -->
            <div class="global-search">
                <svg class="global-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                </svg>
                <input type="text" class="global-search-input" id="global-search" placeholder="Rechercher..." oninput="handleGlobalSearch(this.value)" onfocus="showSearchResults()" onblur="hideSearchResults()">
                <div class="global-search-results" id="search-results"></div>
            </div>

            <nav class="nav">
                <div class="nav-section">
                    <div class="nav-section-title">Menu</div>
                    <button class="nav-item active" data-page="dashboard">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7" rx="1"/>
                            <rect x="14" y="3" width="7" height="7" rx="1"/>
                            <rect x="3" y="14" width="7" height="7" rx="1"/>
                            <rect x="14" y="14" width="7" height="7" rx="1"/>
                        </svg>
                        Tableau de bord
                    </button>
                    <button class="nav-item" data-page="factures">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <path d="M14 2v6h6"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        Factures
                        <span class="nav-badge" id="late-badge" style="display: none;">0</span>
                    </button>
                    <button class="nav-item" data-page="devis">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <path d="M14 2v6h6"/>
                            <path d="M9 15l2 2 4-4"/>
                        </svg>
                        Devis
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Gestion</div>
                    <button class="nav-item" data-page="clients">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        Clients
                    </button>
                    <button class="nav-item" data-page="produits">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                            <line x1="12" y1="22.08" x2="12" y2="12"/>
                        </svg>
                        Produits
                    </button>
                    <button class="nav-item" data-page="prospection">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                            <line x1="11" y1="8" x2="11" y2="14"/>
                            <line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                        Prospection
                        <span class="nav-badge prospect-badge" id="prospect-badge" style="display: none; background: var(--apple-purple);">0</span>
                    </button>
                    <button class="nav-item" data-page="calendrier">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        Calendrier
                    </button>
                    <button class="nav-item" data-page="rapports">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                            <path d="M22 12A10 10 0 0 0 12 2v10z"/>
                        </svg>
                        Rapports
                    </button>
                    <button class="nav-item" data-page="telephone">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        Tlphone
                    </button>
                </div>

                <div class="nav-section" style="margin-top: auto;">
                    <button class="nav-item" data-page="parametres">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                        Paramtres
                    </button>
                    <button class="nav-item" data-page="admin" id="nav-admin" style="display: none;">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        Administration
                    </button>
                </div>
            </nav>
            
            <!-- Theme Toggle -->
            <div class="theme-toggle" onclick="toggleTheme()">
                <span class="theme-toggle-label">Mode sombre</span>
                <div class="theme-toggle-track" id="theme-toggle-track">
                    <div class="theme-toggle-thumb"></div>
                </div>
            </div>
            
            <!-- User Badge -->
            <div class="user-badge" id="user-badge">
                <div class="user-badge-avatar" id="user-avatar">A</div>
                <div class="user-badge-info">
                    <div class="user-badge-name" id="user-display-name">Admin</div>
                    <div class="user-badge-role" id="user-display-role">Administrateur</div>
                </div>
                <button class="user-badge-logout" onclick="logout()" title="Dconnexion">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Dashboard -->
            <div class="page active" id="page-dashboard">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1 class="page-title">Tableau de bord</h1>
                        <p class="page-subtitle">Bienvenue, voici un aperu de votre activit</p>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('invoice')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Nouvelle facture
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                        </div>
                        <div class="stat-value" id="stat-month">0</div>
                        <div class="stat-label">Chiffre du mois</div>
                        <div class="stat-change up">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="18 15 12 9 6 15"/>
                            </svg>
                            +12%
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                        </div>
                        <div class="stat-value" id="stat-pending">0</div>
                        <div class="stat-label">En attente</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <path d="M14 2v6h6"/>
                            </svg>
                        </div>
                        <div class="stat-value" id="stat-total">0</div>
                        <div class="stat-label">Factures totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                        </div>
                        <div class="stat-value" id="stat-late">0</div>
                        <div class="stat-label">En retard</div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Chiffre d'affaires mensuel</h3>
                            <span class="badge" style="background: rgba(0, 122, 255, 0.1); color: var(--apple-blue);" id="chart-year">2025</span>
                        </div>
                        <div class="chart-container">
                            <div class="chart-bar-container" id="revenue-chart"></div>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Statuts des factures</h3>
                        </div>
                        <div class="chart-container">
                            <div class="donut-chart">
                                <svg class="donut-svg" viewBox="0 0 100 100" id="status-donut">
                                    <circle class="donut-segment" cx="50" cy="50" r="40" stroke="var(--apple-gray-5)" stroke-dasharray="251.2" stroke-dashoffset="0"/>
                                </svg>
                                <div class="donut-legend" id="status-legend"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Factures rcentes</h2>
                        <button class="btn btn-ghost" onclick="navigateTo('factures')">Voir tout</button>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Facture</th>
                                    <th>Client</th>
                                    <th>Montant</th>
                                    <th>Date</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-invoices"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Factures -->
            <div class="page" id="page-factures">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1 class="page-title">Factures</h1>
                        <p class="page-subtitle">Grez toutes vos factures</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="sendAllReminders()" id="btn-reminders" style="display: none;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"/>
                            </svg>
                            Envoyer relances
                        </button>
                        <button class="btn btn-primary" onclick="openModal('invoice')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Nouvelle facture
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Facture</th>
                                    <th>Client</th>
                                    <th>Montant</th>
                                    <th>Date</th>
                                    <th>chance</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="all-invoices"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Devis -->
            <div class="page" id="page-devis">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1 class="page-title">Devis</h1>
                        <p class="page-subtitle">Grez vos devis et propositions</p>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('quote')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Nouveau devis
                    </button>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Devis</th>
                                    <th>Client</th>
                                    <th>Montant</th>
                                    <th>Date</th>
                                    <th>Validit</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="all-quotes"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Clients -->
            <div class="page" id="page-clients">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1 class="page-title">Clients</h1>
                        <p class="page-subtitle">Votre carnet de clients</p>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('client')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Nouveau client
                    </button>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Email</th>
                                    <th>Tlphone</th>
                                    <th>Ville</th>
                                    <th>Total factur</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="all-clients"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Produits -->
            <div class="page" id="page-produits">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1 class="page-title">Produits & Services</h1>
                        <p class="page-subtitle">Votre catalogue</p>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('product')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Nouveau produit
                    </button>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Rfrence</th>
                                    <th>Dsignation</th>
                                    <th>Prix HT</th>
                                    <th>TVA</th>
                                    <th>Prix TTC</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="all-products"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Prospection -->
            <div class="page" id="page-prospection">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1 class="page-title">Prospection</h1>
                        <p class="page-subtitle">Grez vos prospects et opportunits</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="openModal('import-prospects')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Importer Excel
                        </button>
                        <button class="btn btn-primary" onclick="openModal('prospect')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Nouveau prospect
                        </button>
                    </div>
                </div>

                <!-- Stats Prospection -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(175, 82, 222, 0.1); color: var(--apple-purple);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="M21 21l-4.35-4.35"/>
                            </svg>
                        </div>
                        <div class="stat-value" id="stat-prospects-total">0</div>
                        <div class="stat-label">Total prospects</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                        </div>
                        <div class="stat-value" id="stat-prospects-interested">0</div>
                        <div class="stat-label">Intresss</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="8.5" cy="7" r="4"/>
                                <polyline points="17 11 19 13 23 9"/>
                            </svg>
                        </div>
                        <div class="stat-value" id="stat-prospects-converted">0</div>
                        <div class="stat-label">Convertis</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                        </div>
                        <div class="stat-value" id="stat-prospects-pending">0</div>
                        <div class="stat-label"> relancer</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Liste des prospects</h2>
                        <div class="card-actions">
                            <select class="form-input" id="filter-prospect-status" onchange="renderAllProspects()" style="width: auto; padding: 8px 12px;">
                                <option value="all">Tous les statuts</option>
                                <option value="new">Nouveaux</option>
                                <option value="contacted">Contacts</option>
                                <option value="interested">Intresss</option>
                                <option value="negotiation">En ngociation</option>
                                <option value="converted">Convertis</option>
                                <option value="lost">Perdus</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Prospect</th>
                                    <th>Contact</th>
                                    <th>Source</th>
                                    <th>Statut</th>
                                    <th>Prochaine action</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="all-prospects"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Calendrier -->
            <div class="page" id="page-calendrier">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1 class="page-title">Calendrier</h1>
                        <p class="page-subtitle">chances et vnements</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="prevMonth()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"/>
                            </svg>
                        </button>
                        <button class="btn btn-secondary" onclick="goToToday()">Aujourd'hui</button>
                        <button class="btn btn-secondary" onclick="nextMonth()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" id="calendar-month-title">Janvier 2025</h2>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="calendar-container">
                            <div class="calendar-header-row">
                                <div class="calendar-header-cell">Lun</div>
                                <div class="calendar-header-cell">Mar</div>
                                <div class="calendar-header-cell">Mer</div>
                                <div class="calendar-header-cell">Jeu</div>
                                <div class="calendar-header-cell">Ven</div>
                                <div class="calendar-header-cell">Sam</div>
                                <div class="calendar-header-cell">Dim</div>
                            </div>
                            <div class="calendar-grid" id="calendar-grid"></div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h2 class="card-title">vnements  venir</h2>
                    </div>
                    <div class="card-body" style="padding: 16px;">
                        <div id="upcoming-events"></div>
                    </div>
                </div>
            </div>

            <!-- Rapports -->
            <div class="page" id="page-rapports">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1 class="page-title">Rapports</h1>
                        <p class="page-subtitle">Analyses et exports comptables</p>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                        </div>
                        <div class="stat-value" id="report-total-ht">0</div>
                        <div class="stat-label">Total HT (anne)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                                <path d="M22 12A10 10 0 0 0 12 2v10z"/>
                            </svg>
                        </div>
                        <div class="stat-value" id="report-total-tva">0</div>
                        <div class="stat-label">TVA collecte</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                            </svg>
                        </div>
                        <div class="stat-value" id="report-total-ttc">0</div>
                        <div class="stat-label">Total TTC</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(175, 82, 222, 0.1); color: var(--apple-purple);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <path d="M14 2v6h6"/>
                            </svg>
                        </div>
                        <div class="stat-value" id="report-count">0</div>
                        <div class="stat-label">Factures payes</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Rapport TVA</h2>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <select class="form-input" id="report-period" style="width: auto;" onchange="updateReports()">
                                <option value="month">Ce mois</option>
                                <option value="quarter">Ce trimestre</option>
                                <option value="year" selected>Cette anne</option>
                                <option value="all">Tout</option>
                            </select>
                            <button class="btn btn-primary" onclick="exportTVAReport()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                Exporter CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Taux TVA</th>
                                    <th>Base HT</th>
                                    <th>Montant TVA</th>
                                    <th>Nb factures</th>
                                </tr>
                            </thead>
                            <tbody id="tva-report-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h2 class="card-title">Chiffre d'affaires par client</h2>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Nb factures</th>
                                    <th>Total HT</th>
                                    <th>Total TTC</th>
                                    <th>% du CA</th>
                                </tr>
                            </thead>
                            <tbody id="client-report-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h2 class="card-title">Export comptable</h2>
                    </div>
                    <div class="card-body" style="padding: 24px;">
                        <p style="color: var(--text-secondary); margin-bottom: 16px;">
                            Exportez vos donnes pour votre comptable ou logiciel comptable.
                        </p>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="exportInvoicesCSV()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <path d="M14 2v6h6"/>
                                </svg>
                                Factures (CSV)
                            </button>
                            <button class="btn btn-secondary" onclick="exportClientsCSV()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                </svg>
                                Clients (CSV)
                            </button>
                            <button class="btn btn-secondary" onclick="exportFullReport()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                Rapport complet (Excel)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tlphone -->
            <div class="page" id="page-telephone">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1 class="page-title">Tlphone</h1>
                        <p class="page-subtitle">Appelez vos clients et prospects</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px;">
                    <!-- Dialer -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Composer</h2>
                        </div>
                        <div class="card-body" style="padding: 24px;">
                            <div class="phone-dialer">
                                <div class="phone-display">
                                    <div class="phone-number" id="phone-display">_</div>
                                    <div class="phone-contact-name" id="phone-contact-match"></div>
                                </div>
                                <div class="phone-keypad">
                                    <button class="phone-key" onclick="dialKey('1')">1<span class="phone-key-sub"></span></button>
                                    <button class="phone-key" onclick="dialKey('2')">2<span class="phone-key-sub">ABC</span></button>
                                    <button class="phone-key" onclick="dialKey('3')">3<span class="phone-key-sub">DEF</span></button>
                                    <button class="phone-key" onclick="dialKey('4')">4<span class="phone-key-sub">GHI</span></button>
                                    <button class="phone-key" onclick="dialKey('5')">5<span class="phone-key-sub">JKL</span></button>
                                    <button class="phone-key" onclick="dialKey('6')">6<span class="phone-key-sub">MNO</span></button>
                                    <button class="phone-key" onclick="dialKey('7')">7<span class="phone-key-sub">PQRS</span></button>
                                    <button class="phone-key" onclick="dialKey('8')">8<span class="phone-key-sub">TUV</span></button>
                                    <button class="phone-key" onclick="dialKey('9')">9<span class="phone-key-sub">WXYZ</span></button>
                                    <button class="phone-key" onclick="dialKey('*')">*</button>
                                    <button class="phone-key" onclick="dialKey('0')">0<span class="phone-key-sub">+</span></button>
                                    <button class="phone-key" onclick="dialKey('#')">#</button>
                                </div>
                                <div class="phone-actions">
                                    <button class="phone-call-btn call" onclick="makeCall()" title="Appeler">
                                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                        </svg>
                                    </button>
                                    <button class="phone-call-btn whatsapp" onclick="makeWhatsAppCall()" title="WhatsApp">
                                        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                        </svg>
                                    </button>
                                    <button class="phone-call-btn end" onclick="clearDialer()" title="Effacer">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="6" x2="6" y2="18"/>
                                            <line x1="6" y1="6" x2="18" y2="18"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Call Log & Contacts -->
                    <div>
                        <div class="card" style="margin-bottom: 24px;">
                            <div class="card-header">
                                <h2 class="card-title">Journal d'appels</h2>
                                <button class="btn btn-ghost" onclick="clearCallLog()">Effacer</button>
                            </div>
                            <div class="card-body" style="padding: 8px 16px; max-height: 300px; overflow-y: auto;">
                                <div id="call-log"></div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Contacts rapides</h2>
                                <div style="display: flex; gap: 8px;" id="quick-contact-filters">
                                    <button class="btn btn-ghost active" id="filter-all" onclick="filterQuickContacts('all')">Tous</button>
                                    <button class="btn btn-ghost" id="filter-clients" onclick="filterQuickContacts('clients')">Clients</button>
                                    <button class="btn btn-ghost" id="filter-prospects" onclick="filterQuickContacts('prospects')">Prospects</button>
                                </div>
                            </div>
                            <div class="card-body" style="padding: 8px 16px; max-height: 400px; overflow-y: auto;">
                                <div id="quick-contacts"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paramtres -->
            <div class="page" id="page-parametres">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1 class="page-title">Paramtres</h1>
                        <p class="page-subtitle">Configurez votre entreprise</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Informations de l'entreprise</h2>
                    </div>
                    <div class="card-body" style="padding: 24px;">
                        <form id="settings-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Nom de l'entreprise</label>
                                    <input type="text" class="form-input" id="company-name" placeholder="Votre entreprise">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">SIRET</label>
                                    <input type="text" class="form-input" id="company-siret" placeholder="123 456 789 00012">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adresse</label>
                                <input type="text" class="form-input" id="company-address" placeholder="123 rue de la Paix">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Code postal</label>
                                    <input type="text" class="form-input" id="company-zip" placeholder="75001">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Ville</label>
                                    <input type="text" class="form-input" id="company-city" placeholder="Paris">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-input" id="company-email" placeholder="contact@entreprise.fr">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tlphone</label>
                                    <input type="tel" class="form-input" id="company-phone" placeholder="01 23 45 67 89">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">IBAN</label>
                                <input type="text" class="form-input" id="company-iban" placeholder="FR76 XXXX XXXX XXXX XXXX XXXX XXX">
                            </div>
                            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                                <button type="button" class="btn btn-secondary" onclick="resetSettings()">Rinitialiser</button>
                                <button type="submit" class="btn btn-primary">Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Administration -->
            <div class="page" id="page-admin">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1 class="page-title">Administration</h1>
                        <p class="page-subtitle">Gestion des utilisateurs et sessions</p>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('user')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Nouvel utilisateur
                    </button>
                </div>

                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(175, 82, 222, 0.1); color: var(--apple-purple);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                        <div class="stat-value" id="stat-users-total">0</div>
                        <div class="stat-label">Utilisateurs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                            </svg>
                        </div>
                        <div class="stat-value" id="stat-admins-total">0</div>
                        <div class="stat-label">Administrateurs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                        </div>
                        <div class="stat-value" id="stat-sessions-active">1</div>
                        <div class="stat-label">Session active</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Liste des utilisateurs</h2>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Utilisateur</th>
                                    <th>Identifiant</th>
                                    <th>Rle</th>
                                    <th>Date de cration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="all-users"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h2 class="card-title">Sauvegarde des donnes</h2>
                    </div>
                    <div class="card-body" style="padding: 24px;">
                        <p style="color: var(--text-secondary); margin-bottom: 16px;">
                            Exportez ou importez toutes les donnes de l'application (utilisateurs, factures, clients, etc.)
                        </p>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-secondary" onclick="exportAllData()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                Exporter les donnes
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('import-data-input').click()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                                Importer les donnes
                            </button>
                            <input type="file" id="import-data-input" accept=".json" style="display: none;" onchange="importAllData(event)">
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modal-overlay">
        <!-- Invoice Modal -->
        <div class="modal" id="modal-invoice" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">Nouvelle facture</h3>
                <button class="modal-close" onclick="closeModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <form id="invoice-form">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Client</label>
                            <select class="form-input" id="invoice-client" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="invoice-date" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Prfixe numro</label>
                            <input type="text" class="form-input" id="invoice-prefix" placeholder="FAC-" value="FAC-" oninput="updateInvoiceNumberPreview()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Numro de facture</label>
                            <input type="number" class="form-input" id="invoice-number" min="1" required oninput="updateInvoiceNumberPreview()">
                            <small id="invoice-number-preview" style="color: var(--apple-blue); font-weight: 500; margin-top: 4px; display: block;"></small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Mode de paiement</label>
                            <select class="form-input" id="invoice-payment-method">
                                <option value="virement">Virement bancaire</option>
                                <option value="cheque">Chque</option>
                                <option value="carte">Carte bancaire</option>
                                <option value="especes">Espces</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dlai de paiement</label>
                            <select class="form-input" id="invoice-payment-delay">
                                <option value="0">Immdiat</option>
                                <option value="15">15 jours</option>
                                <option value="30" selected>30 jours</option>
                                <option value="60">60 jours</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Facture rcurrente</label>
                            <select class="form-input" id="invoice-recurring" onchange="toggleRecurringEnd()">
                                <option value="">Non</option>
                                <option value="monthly">Mensuelle</option>
                                <option value="quarterly">Trimestrielle</option>
                                <option value="yearly">Annuelle</option>
                            </select>
                        </div>
                        <div class="form-group" id="recurring-end-group" style="display: none;">
                            <label class="form-label">Date de fin (optionnel)</label>
                            <input type="date" class="form-input" id="invoice-recurring-end">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Lignes de facture</label>
                        <div class="items-container">
                            <div class="items-header">
                                <span>Produit</span>
                                <span>Qt</span>
                                <span>Prix HT</span>
                                <span>Total</span>
                                <span></span>
                            </div>
                            <div id="invoice-items"></div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addInvoiceItem()" style="width: 100%;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Ajouter une ligne
                        </button>
                    </div>
                    <div class="invoice-summary">
                        <div class="summary-row">
                            <span>Sous-total HT</span>
                            <span id="invoice-subtotal">0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>TVA</span>
                            <span id="invoice-vat">0.00</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total TTC</span>
                            <span id="invoice-total">0.00</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Crer la facture</button>
                </div>
            </form>
        </div>

        <!-- Quote Modal -->
        <div class="modal" id="modal-quote" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">Nouveau devis</h3>
                <button class="modal-close" onclick="closeModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <form id="quote-form">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Client</label>
                            <select class="form-input" id="quote-client" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Validit (jours)</label>
                            <input type="number" class="form-input" id="quote-validity" value="30" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Lignes du devis</label>
                        <div class="items-container">
                            <div class="items-header">
                                <span>Produit</span>
                                <span>Qt</span>
                                <span>Prix HT</span>
                                <span>Total</span>
                                <span></span>
                            </div>
                            <div id="quote-items"></div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addQuoteItem()" style="width: 100%;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Ajouter une ligne
                        </button>
                    </div>
                    <div class="invoice-summary">
                        <div class="summary-row total">
                            <span>Total TTC</span>
                            <span id="quote-total">0.00</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Crer le devis</button>
                </div>
            </form>
        </div>

        <!-- Client Modal -->
        <div class="modal" id="modal-client" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">Nouveau client</h3>
                <button class="modal-close" onclick="closeModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <form id="client-form">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nom / Raison sociale</label>
                            <input type="text" class="form-input" id="client-name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="client-email">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tlphone</label>
                            <input type="tel" class="form-input" id="client-phone">
                        </div>
                        <div class="form-group">
                            <label class="form-label">SIRET</label>
                            <input type="text" class="form-input" id="client-siret">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Adresse</label>
                        <input type="text" class="form-input" id="client-address">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Code postal</label>
                            <input type="text" class="form-input" id="client-zip">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ville</label>
                            <input type="text" class="form-input" id="client-city">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Ajouter</button>
                </div>
            </form>
        </div>

        <!-- Product Modal -->
        <div class="modal" id="modal-product" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">Nouveau produit</h3>
                <button class="modal-close" onclick="closeModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <form id="product-form">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Rfrence</label>
                            <input type="text" class="form-input" id="product-ref" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dsignation</label>
                            <input type="text" class="form-input" id="product-name" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Prix HT ()</label>
                            <input type="number" step="0.01" class="form-input" id="product-price" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">TVA (%)</label>
                            <select class="form-input" id="product-vat">
                                <option value="20">20%</option>
                                <option value="10">10%</option>
                                <option value="5.5">5.5%</option>
                                <option value="0">0%</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Ajouter</button>
                </div>
            </form>
        </div>

        <!-- Prospect Modal -->
        <div class="modal" id="modal-prospect" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">Nouveau prospect</h3>
                <button class="modal-close" onclick="closeModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <form id="prospect-form">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Entreprise / Nom</label>
                            <input type="text" class="form-input" id="prospect-name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact principal</label>
                            <input type="text" class="form-input" id="prospect-contact" placeholder="Nom du contact">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="prospect-email">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tlphone</label>
                            <input type="tel" class="form-input" id="prospect-phone">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Source</label>
                            <select class="form-input" id="prospect-source">
                                <option value="website">Site web</option>
                                <option value="referral">Recommandation</option>
                                <option value="linkedin">LinkedIn</option>
                                <option value="event">vnement / Salon</option>
                                <option value="cold">Prospection directe</option>
                                <option value="ads">Publicit</option>
                                <option value="other">Autre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Statut</label>
                            <select class="form-input" id="prospect-status">
                                <option value="new">Nouveau</option>
                                <option value="contacted">Contact</option>
                                <option value="interested">Intress</option>
                                <option value="negotiation">En ngociation</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Valeur estime ()</label>
                            <input type="number" step="0.01" class="form-input" id="prospect-value" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prochaine action</label>
                            <input type="date" class="form-input" id="prospect-next-action">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-input" id="prospect-notes" rows="3" placeholder="Informations complmentaires..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Ajouter</button>
                </div>
            </form>
        </div>

        <!-- Import Prospects Modal -->
        <div class="modal" id="modal-import-prospects" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">Importer des prospects</h3>
                <button class="modal-close" onclick="closeModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="email-info-card" style="background: linear-gradient(135deg, rgba(52, 199, 89, 0.1) 0%, rgba(0, 122, 255, 0.1) 100%); border-color: rgba(52, 199, 89, 0.2);">
                    <div class="email-info-icon" style="background: var(--apple-green);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <path d="M14 2v6h6"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                    </div>
                    <div class="email-info-content">
                        <div class="email-info-title">Format Excel attendu</div>
                        <div class="email-info-subtitle">Colonnes : Entreprise, Contact, Email, Tlphone, Source, Notes</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Fichier Excel (.xlsx, .xls, .csv)</label>
                    <div id="import-drop-zone" style="border: 2px dashed var(--apple-gray-4); border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: var(--transition);">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--apple-gray-2)" stroke-width="1.5" style="margin-bottom: 12px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p style="color: var(--text-secondary); margin-bottom: 8px;">Glissez-dposez votre fichier ici</p>
                        <p style="color: var(--text-secondary); font-size: 13px;">ou</p>
                        <button type="button" class="btn btn-secondary" style="margin-top: 8px;" onclick="document.getElementById('import-file-input').click()">
                            Parcourir...
                        </button>
                        <input type="file" id="import-file-input" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileSelect(event)">
                    </div>
                    <div id="import-file-name" style="margin-top: 12px; display: none;">
                        <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--apple-gray-6); border-radius: 8px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--apple-green)" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <path d="M14 2v6h6"/>
                            </svg>
                            <span id="import-file-label" style="flex: 1; font-weight: 500;"></span>
                            <button type="button" onclick="clearImportFile()" style="background: none; border: none; cursor: pointer; color: var(--apple-red);">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="import-preview" style="display: none; margin-top: 16px;">
                    <label class="form-label">Aperu des donnes (<span id="import-count">0</span> prospects)</label>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--apple-gray-4); border-radius: 8px;">
                        <table class="table" style="margin: 0;">
                            <thead>
                                <tr>
                                    <th>Entreprise</th>
                                    <th>Contact</th>
                                    <th>Email</th>
                                </tr>
                            </thead>
                            <tbody id="import-preview-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">Statut par dfaut</label>
                    <select class="form-input" id="import-default-status">
                        <option value="new">Nouveau</option>
                        <option value="contacted">Contact</option>
                        <option value="interested">Intress</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="downloadProspectTemplate()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Tlcharger modle
                </button>
                <button type="button" class="btn btn-primary" id="import-btn" onclick="importProspects()" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Importer
                </button>
            </div>
        </div>

        <!-- User Modal -->
        <div class="modal" id="modal-user" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title" id="user-modal-title">Nouvel utilisateur</h3>
                <button class="modal-close" onclick="closeModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <form id="user-form">
                <input type="hidden" id="user-edit-id">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nom d'affichage</label>
                            <input type="text" class="form-input" id="user-display" placeholder="Jean Dupont" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Identifiant de connexion</label>
                            <input type="text" class="form-input" id="user-username" placeholder="jean.dupont" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Code d'accs</label>
                            <input type="password" class="form-input" id="user-password" placeholder="">
                            <small style="color: var(--text-secondary); margin-top: 4px; display: block;">Laissez vide pour ne pas modifier</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirmer le code</label>
                            <input type="password" class="form-input" id="user-password-confirm" placeholder="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rle</label>
                        <select class="form-input" id="user-role">
                            <option value="user">Utilisateur</option>
                            <option value="admin">Administrateur</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="user-submit-btn">Crer l'utilisateur</button>
                </div>
            </form>
        </div>

        <!-- Payment Modal -->
        <div class="modal" id="modal-payment" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">Enregistrer un paiement</h3>
                <button class="modal-close" onclick="closeModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <form id="payment-form">
                <input type="hidden" id="payment-invoice-id">
                <div class="modal-body">
                    <div class="payment-info-card">
                        <div class="payment-info-row">
                            <span>Facture</span>
                            <span id="payment-invoice-number"></span>
                        </div>
                        <div class="payment-info-row">
                            <span>Client</span>
                            <span id="payment-invoice-client"></span>
                        </div>
                        <div class="payment-info-row">
                            <span>Montant</span>
                            <span id="payment-invoice-amount" style="color: var(--apple-blue);"></span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date de paiement</label>
                            <input type="date" class="form-input" id="payment-date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mode de paiement</label>
                            <select class="form-input" id="payment-method">
                                <option value="virement">Virement bancaire</option>
                                <option value="cheque">Chque</option>
                                <option value="carte">Carte bancaire</option>
                                <option value="especes">Espces</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rfrence (optionnel)</label>
                        <input type="text" class="form-input" id="payment-reference" placeholder="N de chque, rfrence virement...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Marquer comme paye
                    </button>
                </div>
            </form>
        </div>

        <!-- Email Modal -->
        <div class="modal" id="modal-email" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">Envoyer par email</h3>
                <button class="modal-close" onclick="closeModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <form onsubmit="sendEmail(event)">
                <div class="modal-body">
                    <div class="email-info-card">
                        <div class="email-info-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <path d="M14 2v6h6"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                            </svg>
                        </div>
                        <div class="email-info-content">
                            <div class="email-info-title" id="email-doc-title">Document</div>
                            <div class="email-info-subtitle" id="email-doc-subtitle">Montant</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Destinataire</label>
                        <input type="email" class="form-input" id="email-to" placeholder="email@exemple.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Objet</label>
                        <input type="text" class="form-input" id="email-subject" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message</label>
                        <textarea class="form-input" id="email-body" rows="6" style="resize: vertical;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
                        </svg>
                        Envoyer
                    </button>
                </div>
            </form>
        </div>

        <!-- Preview Modal -->
        <div class="modal modal-preview" id="modal-preview" style="display: none;">
            <div class="preview-toolbar">
                <h3 id="preview-title">Aperu</h3>
                <div class="preview-actions">
                    <button class="btn btn-secondary" onclick="printInvoice()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 6 2 18 2 18 9"/>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                            <rect x="6" y="14" width="12" height="8"/>
                        </svg>
                        Imprimer
                    </button>
                    <button class="btn btn-primary" onclick="downloadPDF()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Tlcharger PDF
                    </button>
                    <button class="btn btn-success" onclick="openEmailFromPreview()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
                        </svg>
                        Envoyer
                    </button>
                    <button class="modal-close" onclick="closeModal()" style="background: rgba(255,255,255,0.1); color: white;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="preview-content">
                <div class="invoice-doc" id="invoice-document"></div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <div class="toast-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
        </div>
        <span id="toast-message"></span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Developer Panel -->
    <div class="dev-panel-overlay" id="dev-panel-overlay" onclick="closeDevPanel(event)">
        <div class="dev-panel" onclick="event.stopPropagation()">
            <div class="dev-panel-header">
                <div class="dev-panel-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="16 18 22 12 16 6"/>
                        <polyline points="8 6 2 12 8 18"/>
                    </svg>
                    Mode Dveloppeur
                </div>
                <button class="dev-panel-close" onclick="closeDevPanel()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="dev-panel-body">
                <div class="dev-warning">
                    <svg class="dev-warning-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <div class="dev-warning-text">
                        Ces options sont destines aux dveloppeurs et utilisateurs avancs. Activez ou dsactivez des modules selon vos besoins.
                    </div>
                </div>

                <div class="dev-section">
                    <div class="dev-section-title">Modules</div>
                    
                    <div class="module-item">
                        <div class="module-icon" style="background: linear-gradient(135deg, var(--apple-green), #00C853);">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            </svg>
                        </div>
                        <div class="module-info">
                            <div class="module-name">Tlphone</div>
                            <div class="module-desc">Appels, WhatsApp, journal d'appels</div>
                        </div>
                        <div class="module-toggle" id="module-phone-toggle" onclick="toggleModule('phone')">
                            <div class="module-toggle-thumb"></div>
                        </div>
                    </div>

                    <div class="module-item">
                        <div class="module-icon" style="background: linear-gradient(135deg, var(--apple-purple), var(--apple-blue));">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="M21 21l-4.35-4.35"/>
                                <line x1="11" y1="8" x2="11" y2="14"/>
                                <line x1="8" y1="11" x2="14" y2="11"/>
                            </svg>
                        </div>
                        <div class="module-info">
                            <div class="module-name">Prospection CRM</div>
                            <div class="module-desc">Gestion des prospects et pipeline</div>
                        </div>
                        <div class="module-toggle" id="module-prospection-toggle" onclick="toggleModule('prospection')">
                            <div class="module-toggle-thumb"></div>
                        </div>
                    </div>

                    <div class="module-item">
                        <div class="module-icon" style="background: linear-gradient(135deg, var(--apple-orange), #FF6D00);">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                        </div>
                        <div class="module-info">
                            <div class="module-name">Calendrier</div>
                            <div class="module-desc">Vue calendrier des chances</div>
                        </div>
                        <div class="module-toggle" id="module-calendrier-toggle" onclick="toggleModule('calendrier')">
                            <div class="module-toggle-thumb"></div>
                        </div>
                    </div>

                    <div class="module-item">
                        <div class="module-icon" style="background: linear-gradient(135deg, var(--apple-blue), #2979FF);">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                                <path d="M22 12A10 10 0 0 0 12 2v10z"/>
                            </svg>
                        </div>
                        <div class="module-info">
                            <div class="module-name">Rapports</div>
                            <div class="module-desc">Analyses TVA et exports comptables</div>
                        </div>
                        <div class="module-toggle" id="module-rapports-toggle" onclick="toggleModule('rapports')">
                            <div class="module-toggle-thumb"></div>
                        </div>
                    </div>
                </div>

                <div class="dev-info">
                    AVA Facturation v2.0  Dvelopp avec 
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== AUTHENTICATION & USERS ==========
        let currentUser = null;
        let users = [];
        
        // Initialize users from localStorage
        function initUsers() {
            const savedUsers = localStorage.getItem('avaFacturationUsers');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            } else {
                // Create default admin user
                users = [{
                    id: 1,
                    username: 'admin',
                    password: 'admin',
                    displayName: 'Administrateur',
                    role: 'admin',
                    createdAt: new Date().toISOString().split('T')[0]
                }];
                saveUsers();
            }
        }
        
        function saveUsers() {
            localStorage.setItem('avaFacturationUsers', JSON.stringify(users));
        }
        
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('avaFacturationCurrentUser', JSON.stringify(user));
                document.getElementById('login-error').classList.remove('show');
                showApp();
            } else {
                document.getElementById('login-error').classList.add('show');
            }
        }
        
        function logout() {
            if (confirm('Voulez-vous vraiment vous dconnecter ?')) {
                currentUser = null;
                localStorage.removeItem('avaFacturationCurrentUser');
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
                document.getElementById('login-username').value = '';
                document.getElementById('login-password').value = '';
            }
        }
        
        function showApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            // Update user badge
            const initials = currentUser.displayName.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('user-avatar').textContent = initials;
            document.getElementById('user-display-name').textContent = currentUser.displayName;
            document.getElementById('user-display-role').textContent = currentUser.role === 'admin' ? 'Administrateur' : 'Utilisateur';
            
            // Show/hide admin nav
            if (currentUser.role === 'admin') {
                document.getElementById('nav-admin').style.display = 'flex';
            } else {
                document.getElementById('nav-admin').style.display = 'none';
            }
            
            // Load user data
            loadData();
            
            // Check for recurring invoices to generate
            generateRecurringInvoices();
            
            // Check for late invoices
            checkLateInvoices();
            
            // Apply module states (show/hide modules based on settings)
            applyModuleStates();
            
            refreshPage('dashboard');
        }
        
        function checkLateInvoices() {
            const today = new Date().toISOString().split('T')[0];
            let updated = false;
            
            data.invoices.forEach(inv => {
                if (inv.status === 'pending' && inv.dueDate < today) {
                    inv.status = 'late';
                    updated = true;
                }
            });
            
            if (updated) {
                saveData();
            }
        }
        
        function checkSession() {
            initUsers();
            const savedSession = localStorage.getItem('avaFacturationCurrentUser');
            if (savedSession) {
                const sessionUser = JSON.parse(savedSession);
                // Verify user still exists
                const user = users.find(u => u.id === sessionUser.id && u.password === sessionUser.password);
                if (user) {
                    currentUser = user;
                    showApp();
                    return;
                }
            }
            // Show login screen
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
        }

        // ========== DATA STORE ==========
        let data = {
            invoices: [],
            quotes: [],
            clients: [],
            products: [],
            prospects: [],
            settings: {},
            invoicePrefix: 'FAC-',
            nextInvoiceNum: 1,
            nextQuoteNum: 1,
            nextProspectNum: 1
        };

        let currentPreviewInvoice = null;
        let currentPreviewQuote = null;
        let currentPreviewType = 'invoice';

        // ========== LOAD/SAVE (Per User) ==========
        function getStorageKey() {
            return currentUser ? `avaFacturationData_${currentUser.id}` : 'avaFacturationData_guest';
        }
        
        function loadData() {
            const saved = localStorage.getItem(getStorageKey());
            if (saved) {
                data = JSON.parse(saved);
            } else {
                // Sample data for new users
                data = {
                    invoices: [],
                    quotes: [],
                    clients: [
                        { id: 1, name: 'TechCorp SARL', email: 'contact@techcorp.fr', phone: '01 23 45 67 89', siret: '', address: '12 rue de la Tech', zip: '75001', city: 'Paris' },
                        { id: 2, name: 'StartupXYZ', email: 'hello@startupxyz.io', phone: '01 98 76 54 32', siret: '', address: '5 avenue Innovation', zip: '69001', city: 'Lyon' },
                        { id: 3, name: 'AgenceABC', email: 'info@agenceabc.com', phone: '04 56 78 90 12', siret: '', address: '8 boulevard Cratif', zip: '33000', city: 'Bordeaux' }
                    ],
                    products: [
                        { id: 1, ref: 'DEV-001', name: 'Dveloppement web', price: 500, vat: 20 },
                        { id: 2, ref: 'DES-001', name: 'Design UI/UX', price: 350, vat: 20 },
                        { id: 3, ref: 'CON-001', name: 'Consulting (heure)', price: 150, vat: 20 }
                    ],
                    prospects: [],
                    settings: {},
                    invoicePrefix: 'FAC-',
                    nextInvoiceNum: 1,
                    nextQuoteNum: 1,
                    nextProspectNum: 1
                };
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem(getStorageKey(), JSON.stringify(data));
        }

        // ========== NAVIGATION ==========
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                navigateTo(page);
            });
        });

        function navigateTo(page) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.add('active');
            
            refreshPage(page);
        }

        function refreshPage(page) {
            switch(page) {
                case 'dashboard': updateStats(); renderRecentInvoices(); break;
                case 'factures': renderAllInvoices(); break;
                case 'devis': renderAllQuotes(); break;
                case 'clients': renderAllClients(); break;
                case 'produits': renderAllProducts(); break;
                case 'prospection': renderAllProspects(); updateProspectStats(); break;
                case 'parametres': loadSettings(); break;
                case 'admin': renderAllUsers(); updateAdminStats(); break;
                case 'calendrier': renderCalendar(); break;
                case 'rapports': updateReports(); break;
                case 'telephone': renderPhonePage(); break;
            }
        }

        // ========== ADMIN / USER MANAGEMENT ==========
        function renderAllUsers() {
            const tbody = document.getElementById('all-users');
            if (!tbody) return;
            
            if (users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><h3>Aucun utilisateur</h3><p>Ajoutez le premier utilisateur</p></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = users.map(u => {
                const initials = u.displayName.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                const isCurrentUser = currentUser && currentUser.id === u.id;
                return `
                    <tr>
                        <td>
                            <div class="client-cell">
                                <div class="client-avatar" style="background: linear-gradient(135deg, ${u.role === 'admin' ? 'var(--apple-purple), var(--apple-blue)' : 'var(--apple-blue), var(--apple-green)'});">${initials}</div>
                                <div class="client-info">
                                    <span class="client-name">${u.displayName}</span>
                                    ${isCurrentUser ? '<span style="font-size: 11px; color: var(--apple-green); font-weight: 500;">(Vous)</span>' : ''}
                                </div>
                            </div>
                        </td>
                        <td><code style="background: var(--apple-gray-6); padding: 4px 8px; border-radius: 6px; font-size: 13px;">${u.username}</code></td>
                        <td>${u.role === 'admin' ? '<span class="badge" style="background: rgba(175, 82, 222, 0.1); color: var(--apple-purple);">Administrateur</span>' : '<span class="badge" style="background: rgba(0, 122, 255, 0.1); color: var(--apple-blue);">Utilisateur</span>'}</td>
                        <td>${formatDate(u.createdAt)}</td>
                        <td>
                            <div class="actions">
                                <button class="action-btn" onclick="editUser(${u.id})" title="Modifier"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                                ${!isCurrentUser ? `<button class="action-btn danger" onclick="deleteUser(${u.id})" title="Supprimer"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateAdminStats() {
            document.getElementById('stat-users-total').textContent = users.length;
            document.getElementById('stat-admins-total').textContent = users.filter(u => u.role === 'admin').length;
            document.getElementById('stat-sessions-active').textContent = '1';
        }
        
        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            document.getElementById('user-edit-id').value = user.id;
            document.getElementById('user-display').value = user.displayName;
            document.getElementById('user-username').value = user.username;
            document.getElementById('user-password').value = '';
            document.getElementById('user-password-confirm').value = '';
            document.getElementById('user-role').value = user.role;
            
            document.getElementById('user-modal-title').textContent = 'Modifier l\'utilisateur';
            document.getElementById('user-submit-btn').textContent = 'Enregistrer';
            
            openModal('user');
        }
        
        function deleteUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            if (currentUser && currentUser.id === id) {
                showToast('Vous ne pouvez pas supprimer votre propre compte', 'error');
                return;
            }
            
            if (confirm(`Supprimer l'utilisateur "${user.displayName}" ?\n\nAttention : Toutes ses donnes seront galement supprimes.`)) {
                // Delete user data
                localStorage.removeItem(`avaFacturationData_${user.id}`);
                
                // Remove user
                users = users.filter(u => u.id !== id);
                saveUsers();
                
                renderAllUsers();
                updateAdminStats();
                showToast('Utilisateur supprim', 'success');
            }
        }
        
        // User form submission
        document.getElementById('user-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const editId = document.getElementById('user-edit-id').value;
            const displayName = document.getElementById('user-display').value.trim();
            const username = document.getElementById('user-username').value.trim().toLowerCase();
            const password = document.getElementById('user-password').value;
            const passwordConfirm = document.getElementById('user-password-confirm').value;
            const role = document.getElementById('user-role').value;
            
            // Validation
            if (password && password !== passwordConfirm) {
                showToast('Les codes d\'accs ne correspondent pas', 'error');
                return;
            }
            
            // Check username uniqueness
            const existingUser = users.find(u => u.username === username && (!editId || u.id !== parseInt(editId)));
            if (existingUser) {
                showToast('Cet identifiant est dj utilis', 'error');
                return;
            }
            
            if (editId) {
                // Edit existing user
                const user = users.find(u => u.id === parseInt(editId));
                if (user) {
                    user.displayName = displayName;
                    user.username = username;
                    user.role = role;
                    if (password) {
                        user.password = password;
                    }
                    
                    // Update current user session if editing self
                    if (currentUser && currentUser.id === user.id) {
                        currentUser = user;
                        localStorage.setItem('avaFacturationCurrentUser', JSON.stringify(user));
                        showApp(); // Refresh UI
                    }
                }
                showToast('Utilisateur modifi', 'success');
            } else {
                // Create new user
                if (!password) {
                    showToast('Le code d\'accs est requis pour un nouvel utilisateur', 'error');
                    return;
                }
                
                const newUser = {
                    id: Date.now(),
                    username: username,
                    password: password,
                    displayName: displayName,
                    role: role,
                    createdAt: new Date().toISOString().split('T')[0]
                };
                
                users.push(newUser);
                showToast('Utilisateur cr', 'success');
            }
            
            saveUsers();
            closeModal();
            renderAllUsers();
            updateAdminStats();
            
            // Reset form
            document.getElementById('user-form').reset();
            document.getElementById('user-edit-id').value = '';
            document.getElementById('user-modal-title').textContent = 'Nouvel utilisateur';
            document.getElementById('user-submit-btn').textContent = 'Crer l\'utilisateur';
        });
        
        // Export all data
        function exportAllData() {
            const exportData = {
                users: users,
                userData: {}
            };
            
            // Get all user data
            users.forEach(u => {
                const userData = localStorage.getItem(`avaFacturationData_${u.id}`);
                if (userData) {
                    exportData.userData[u.id] = JSON.parse(userData);
                }
            });
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ava-facturation-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Donnes exportes', 'success');
        }
        
        // Import all data
        function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.users || !Array.isArray(importData.users)) {
                        showToast('Fichier de sauvegarde invalide', 'error');
                        return;
                    }
                    
                    if (confirm('Attention : Cette action remplacera toutes les donnes existantes.\n\nVoulez-vous continuer ?')) {
                        // Import users
                        users = importData.users;
                        saveUsers();
                        
                        // Import user data
                        if (importData.userData) {
                            Object.keys(importData.userData).forEach(userId => {
                                localStorage.setItem(`avaFacturationData_${userId}`, JSON.stringify(importData.userData[userId]));
                            });
                        }
                        
                        // Reload current user data
                        loadData();
                        renderAllUsers();
                        updateAdminStats();
                        
                        showToast('Donnes importes avec succs', 'success');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('Erreur lors de l\'import', 'error');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // ========== STATS ==========
        function updateStats() {
            const now = new Date();
            const thisMonth = data.invoices.filter(inv => {
                const d = new Date(inv.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
            
            const monthTotal = thisMonth.reduce((sum, inv) => sum + inv.total, 0);
            const pendingTotal = data.invoices.filter(i => i.status === 'pending').reduce((sum, inv) => sum + inv.total, 0);
            const lateCount = data.invoices.filter(i => i.status === 'late').length;

            animateValue('stat-month', monthTotal, '');
            animateValue('stat-pending', pendingTotal, '');
            animateValue('stat-total', data.invoices.length);
            animateValue('stat-late', lateCount);

            // Update badge
            const badge = document.getElementById('late-badge');
            if (lateCount > 0) {
                badge.style.display = 'block';
                badge.textContent = lateCount;
            } else {
                badge.style.display = 'none';
            }
            
            // Render charts
            renderRevenueChart();
            renderStatusDonut();
        }
        
        function renderRevenueChart() {
            const container = document.getElementById('revenue-chart');
            if (!container) return;
            
            const now = new Date();
            const year = now.getFullYear();
            document.getElementById('chart-year').textContent = year;
            
            const months = ['Jan', 'Fv', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aot', 'Sep', 'Oct', 'Nov', 'Dc'];
            const monthlyData = [];
            
            for (let i = 0; i < 12; i++) {
                const monthInvoices = data.invoices.filter(inv => {
                    const d = new Date(inv.date);
                    return d.getMonth() === i && d.getFullYear() === year;
                });
                monthlyData.push(monthInvoices.reduce((sum, inv) => sum + inv.total, 0));
            }
            
            const maxValue = Math.max(...monthlyData, 1);
            
            container.innerHTML = monthlyData.map((value, i) => {
                const height = (value / maxValue) * 140;
                return `
                    <div class="chart-bar-item">
                        <div class="chart-bar-value">${value > 0 ? '' + (value/1000).toFixed(1) + 'k' : ''}</div>
                        <div class="chart-bar" style="height: ${Math.max(height, 4)}px;" title="${value.toLocaleString()}"></div>
                        <div class="chart-bar-label">${months[i]}</div>
                    </div>
                `;
            }).join('');
        }
        
        function renderStatusDonut() {
            const svg = document.getElementById('status-donut');
            const legend = document.getElementById('status-legend');
            if (!svg || !legend) return;
            
            const paid = data.invoices.filter(i => i.status === 'paid').length;
            const pending = data.invoices.filter(i => i.status === 'pending').length;
            const late = data.invoices.filter(i => i.status === 'late').length;
            const total = paid + pending + late;
            
            if (total === 0) {
                svg.innerHTML = `<circle class="donut-segment" cx="50" cy="50" r="40" stroke="var(--apple-gray-5)" stroke-dasharray="251.2" stroke-dashoffset="0"/>`;
                legend.innerHTML = `<div class="donut-legend-item"><span style="color: var(--text-secondary);">Aucune facture</span></div>`;
                return;
            }
            
            const circumference = 251.2; // 2 * PI * 40
            const paidLen = (paid / total) * circumference;
            const pendingLen = (pending / total) * circumference;
            const lateLen = (late / total) * circumference;
            
            let offset = 0;
            let segments = '';
            
            if (paid > 0) {
                segments += `<circle class="donut-segment" cx="50" cy="50" r="40" stroke="var(--apple-green)" stroke-dasharray="${paidLen} ${circumference - paidLen}" stroke-dashoffset="-${offset}"/>`;
                offset += paidLen;
            }
            if (pending > 0) {
                segments += `<circle class="donut-segment" cx="50" cy="50" r="40" stroke="var(--apple-orange)" stroke-dasharray="${pendingLen} ${circumference - pendingLen}" stroke-dashoffset="-${offset}"/>`;
                offset += pendingLen;
            }
            if (late > 0) {
                segments += `<circle class="donut-segment" cx="50" cy="50" r="40" stroke="var(--apple-red)" stroke-dasharray="${lateLen} ${circumference - lateLen}" stroke-dashoffset="-${offset}"/>`;
            }
            
            svg.innerHTML = segments;
            
            legend.innerHTML = `
                <div class="donut-legend-item">
                    <div class="donut-legend-color" style="background: var(--apple-green);"></div>
                    <span class="donut-legend-label">Payes</span>
                    <span class="donut-legend-value">${paid}</span>
                </div>
                <div class="donut-legend-item">
                    <div class="donut-legend-color" style="background: var(--apple-orange);"></div>
                    <span class="donut-legend-label">En attente</span>
                    <span class="donut-legend-value">${pending}</span>
                </div>
                <div class="donut-legend-item">
                    <div class="donut-legend-color" style="background: var(--apple-red);"></div>
                    <span class="donut-legend-label">En retard</span>
                    <span class="donut-legend-value">${late}</span>
                </div>
            `;
        }

        function animateValue(id, target, prefix = '') {
            const el = document.getElementById(id);
            const duration = 800;
            const start = 0;
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(start + (target - start) * eased);
                el.textContent = prefix + current.toLocaleString();
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        // ========== RENDER FUNCTIONS ==========
        function renderRecentInvoices() {
            const tbody = document.getElementById('recent-invoices');
            const recent = [...data.invoices].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            
            if (recent.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg></div><h3>Aucune facture</h3><p>Crez votre premire facture</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = recent.map(inv => {
                const client = data.clients.find(c => c.id === inv.clientId);
                const initials = client ? client.name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase() : '??';
                return `
                    <tr>
                        <td><strong>${inv.number}</strong></td>
                        <td>
                            <div class="client-cell">
                                <div class="client-avatar">${initials}</div>
                                <div class="client-info">
                                    <span class="client-name">${client ? client.name : 'Inconnu'}</span>
                                    <span class="client-email">${client ? client.email : ''}</span>
                                </div>
                            </div>
                        </td>
                        <td><strong>${inv.total.toLocaleString()}</strong></td>
                        <td>${formatDate(inv.date)}</td>
                        <td>${getStatusBadge(inv.status)}</td>
                        <td>
                            <div class="actions">
                                <button class="action-btn" onclick="viewInvoice(${inv.id})" title="Aperu">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                </button>
                                <button class="action-btn email" onclick="openEmailModal(${inv.id}, 'invoice')" title="Envoyer par email">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
                                </button>
                                ${inv.status !== 'paid' ? `<button class="action-btn" onclick="openPaymentModal(${inv.id})" title="Paiement"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></button>` : ''}
                                <button class="action-btn danger" onclick="deleteInvoice(${inv.id})" title="Supprimer">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderAllInvoices() {
            const tbody = document.getElementById('all-invoices');
            const invoices = [...data.invoices].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (invoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg></div><h3>Aucune facture</h3><p>Crez votre premire facture</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = invoices.map(inv => {
                const client = data.clients.find(c => c.id === inv.clientId);
                const initials = client ? client.name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase() : '??';
                const recurringLabel = inv.recurring ? getRecurringLabel(inv.recurring) : '';
                return `
                    <tr>
                        <td>
                            <strong>${inv.number}</strong>
                            ${inv.recurring ? `<span class="recurring-badge"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> ${recurringLabel}</span>` : ''}
                        </td>
                        <td>
                            <div class="client-cell">
                                <div class="client-avatar">${initials}</div>
                                <span class="client-name">${client ? client.name : 'Inconnu'}</span>
                            </div>
                        </td>
                        <td><strong>${inv.total.toLocaleString()}</strong></td>
                        <td>${formatDate(inv.date)}</td>
                        <td>${formatDate(inv.dueDate)}</td>
                        <td>${getStatusBadge(inv.status)}</td>
                        <td>
                            <div class="actions">
                                <button class="action-btn" onclick="viewInvoice(${inv.id})" title="Aperu"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                                <button class="action-btn" onclick="quickDownloadPDF(${inv.id})" title="PDF"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                                <button class="action-btn email" onclick="openEmailModal(${inv.id}, 'invoice')" title="Envoyer par email"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg></button>
                                ${inv.status !== 'paid' ? `<button class="action-btn" onclick="openPaymentModal(${inv.id})" title="Paiement"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></button>` : ''}
                                <button class="action-btn" onclick="duplicateInvoice(${inv.id})" title="Dupliquer"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                                <button class="action-btn danger" onclick="deleteInvoice(${inv.id})" title="Supprimer"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Show/hide reminders button
            const lateOrPending = data.invoices.filter(i => i.status === 'late' || i.status === 'pending').length;
            const btnReminders = document.getElementById('btn-reminders');
            if (btnReminders) {
                btnReminders.style.display = lateOrPending > 0 ? 'flex' : 'none';
            }
        }
        
        function getRecurringLabel(frequency) {
            switch(frequency) {
                case 'monthly': return 'Mensuelle';
                case 'quarterly': return 'Trimestrielle';
                case 'yearly': return 'Annuelle';
                default: return '';
            }
        }
        
        function duplicateInvoice(id) {
            const inv = data.invoices.find(i => i.id === id);
            if (!inv) return;
            
            const num = data.nextInvoiceNum++;
            const prefix = data.invoicePrefix || 'FAC-';
            const today = new Date().toISOString().split('T')[0];
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + (inv.paymentDelay || 30));
            
            const newInvoice = {
                id: Date.now(),
                number: `${prefix}${String(num).padStart(3, '0')}`,
                clientId: inv.clientId,
                date: today,
                dueDate: dueDate.toISOString().split('T')[0],
                paymentMethod: inv.paymentMethod,
                paymentDelay: inv.paymentDelay,
                items: [...inv.items],
                totalHT: inv.totalHT,
                total: inv.total,
                status: 'pending'
            };
            
            data.invoices.push(newInvoice);
            saveData();
            renderAllInvoices();
            showToast('Facture duplique', 'success');
        }

        function renderAllQuotes() {
            const tbody = document.getElementById('all-quotes');
            if (data.quotes.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg></div><h3>Aucun devis</h3><p>Crez votre premier devis</p></div></td></tr>`;
                return;
            }
            tbody.innerHTML = data.quotes.map(q => {
                const client = data.clients.find(c => c.id === q.clientId);
                return `
                    <tr>
                        <td><strong>${q.number}</strong></td>
                        <td>${client ? client.name : 'Inconnu'}</td>
                        <td><strong>${q.total.toLocaleString()}</strong></td>
                        <td>${formatDate(q.date)}</td>
                        <td>${q.validity} jours</td>
                        <td>${getQuoteStatusBadge(q.status)}</td>
                        <td>
                            <div class="actions">
                                <button class="action-btn" onclick="viewQuote(${q.id})" title="Aperu"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                                <button class="action-btn email" onclick="openEmailModal(${q.id}, 'quote')" title="Envoyer par email"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg></button>
                                <button class="action-btn" onclick="convertToInvoice(${q.id})" title="Convertir"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg></button>
                                <button class="action-btn danger" onclick="deleteQuote(${q.id})" title="Supprimer"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderAllClients() {
            const tbody = document.getElementById('all-clients');
            if (data.clients.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><h3>Aucun client</h3><p>Ajoutez votre premier client</p></div></td></tr>`;
                return;
            }
            tbody.innerHTML = data.clients.map(c => {
                const total = data.invoices.filter(i => i.clientId === c.id).reduce((sum, i) => sum + i.total, 0);
                const initials = c.name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                return `
                    <tr>
                        <td>
                            <div class="client-cell">
                                <div class="client-avatar">${initials}</div>
                                <div class="client-info">
                                    <span class="client-name">${c.name}</span>
                                    <span class="client-email">${c.city || ''}</span>
                                </div>
                            </div>
                        </td>
                        <td>${c.email || '-'}</td>
                        <td>${c.phone || '-'}</td>
                        <td>${c.city || '-'}</td>
                        <td><strong>${total.toLocaleString()}</strong></td>
                        <td>
                            <div class="actions">
                                ${c.phone && modules.phone ? `
                                    <button class="action-btn" style="color: var(--apple-green);" onclick="callContact('${c.phone}')" title="Appeler"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg></button>
                                    <button class="action-btn" style="color: #25D366;" onclick="whatsappContact('${c.phone}')" title="WhatsApp"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/></svg></button>
                                ` : ''}
                                <button class="action-btn" onclick="editClient(${c.id})" title="Modifier"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                                <button class="action-btn danger" onclick="deleteClient(${c.id})" title="Supprimer"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderAllProducts() {
            const tbody = document.getElementById('all-products');
            if (data.products.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg></div><h3>Aucun produit</h3><p>Ajoutez votre premier produit</p></div></td></tr>`;
                return;
            }
            tbody.innerHTML = data.products.map(p => {
                const ttc = p.price * (1 + p.vat / 100);
                return `
                    <tr>
                        <td><strong>${p.ref}</strong></td>
                        <td>${p.name}</td>
                        <td>${p.price.toFixed(2)}</td>
                        <td>${p.vat}%</td>
                        <td><strong>${ttc.toFixed(2)}</strong></td>
                        <td>
                            <div class="actions">
                                <button class="action-btn danger" onclick="deleteProduct(${p.id})" title="Supprimer"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== PROSPECTION ==========
        function renderAllProspects() {
            const tbody = document.getElementById('all-prospects');
            const filterStatus = document.getElementById('filter-prospect-status')?.value || 'all';
            
            if (!data.prospects) data.prospects = [];
            
            let prospects = [...data.prospects];
            if (filterStatus !== 'all') {
                prospects = prospects.filter(p => p.status === filterStatus);
            }
            
            if (prospects.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg></div><h3>Aucun prospect</h3><p>Ajoutez votre premier prospect</p></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = prospects.map(p => {
                const nextActionDate = p.nextAction ? new Date(p.nextAction) : null;
                const isOverdue = nextActionDate && nextActionDate < new Date();
                return `
                    <tr>
                        <td>
                            <div class="client-cell">
                                <div class="client-avatar" style="background: linear-gradient(135deg, var(--apple-purple), var(--apple-blue));">${p.name.substring(0, 2).toUpperCase()}</div>
                                <div class="client-info">
                                    <span class="client-name">${p.name}</span>
                                    <span class="client-email">${p.value ? '' + p.value.toLocaleString() + ' estim' : ''}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>${p.contact || '-'}</div>
                            <small style="color: var(--text-secondary);">${p.email || ''}</small>
                        </td>
                        <td>${getSourceLabel(p.source)}</td>
                        <td>${getProspectStatusBadge(p.status)}</td>
                        <td>
                            ${p.nextAction ? `<span style="color: ${isOverdue ? 'var(--apple-red)' : 'var(--text-primary)'}; font-weight: ${isOverdue ? '600' : '400'};">${formatDate(p.nextAction)}</span>` : '<span style="color: var(--text-secondary);">-</span>'}
                        </td>
                        <td>
                            <div class="actions">
                                ${p.phone && modules.phone ? `
                                    <button class="action-btn" style="color: var(--apple-green);" onclick="callContact('${p.phone}')" title="Appeler"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg></button>
                                    <button class="action-btn" style="color: #25D366;" onclick="whatsappContact('${p.phone}')" title="WhatsApp"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/></svg></button>
                                ` : ''}
                                <button class="action-btn email" onclick="openProspectEmailModal(${p.id})" title="Envoyer un email"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg></button>
                                <button class="action-btn" onclick="editProspect(${p.id})" title="Modifier"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                                <button class="action-btn" style="color: var(--apple-blue);" onclick="convertProspectToClient(${p.id})" title="Convertir en client"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg></button>
                                <button class="action-btn danger" onclick="deleteProspect(${p.id})" title="Supprimer"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateProspectStats() {
            if (!data.prospects) data.prospects = [];
            const total = data.prospects.length;
            const interested = data.prospects.filter(p => p.status === 'interested' || p.status === 'negotiation').length;
            const converted = data.prospects.filter(p => p.status === 'converted').length;
            const pending = data.prospects.filter(p => {
                if (!p.nextAction) return false;
                return new Date(p.nextAction) <= new Date() && p.status !== 'converted' && p.status !== 'lost';
            }).length;
            
            document.getElementById('stat-prospects-total').textContent = total;
            document.getElementById('stat-prospects-interested').textContent = interested;
            document.getElementById('stat-prospects-converted').textContent = converted;
            document.getElementById('stat-prospects-pending').textContent = pending;
            
            // Update badge
            const badge = document.getElementById('prospect-badge');
            if (pending > 0) {
                badge.textContent = pending;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function getProspectStatusBadge(status) {
            const badges = {
                new: '<span class="badge" style="background: rgba(175, 82, 222, 0.1); color: var(--apple-purple);">Nouveau</span>',
                contacted: '<span class="badge" style="background: rgba(0, 122, 255, 0.1); color: var(--apple-blue);">Contact</span>',
                interested: '<span class="badge" style="background: rgba(255, 149, 0, 0.1); color: var(--apple-orange);">Intress</span>',
                negotiation: '<span class="badge badge-warning">En ngociation</span>',
                converted: '<span class="badge badge-success">Converti</span>',
                lost: '<span class="badge badge-danger">Perdu</span>'
            };
            return badges[status] || badges.new;
        }

        function getSourceLabel(source) {
            const sources = {
                website: 'Site web',
                referral: 'Recommandation',
                linkedin: 'LinkedIn',
                event: 'vnement',
                cold: 'Prospection',
                ads: 'Publicit',
                other: 'Autre'
            };
            return sources[source] || source;
        }

        function editProspect(id) {
            const prospect = data.prospects.find(p => p.id === id);
            if (!prospect) return;
            
            document.getElementById('prospect-name').value = prospect.name || '';
            document.getElementById('prospect-contact').value = prospect.contact || '';
            document.getElementById('prospect-email').value = prospect.email || '';
            document.getElementById('prospect-phone').value = prospect.phone || '';
            document.getElementById('prospect-source').value = prospect.source || 'website';
            document.getElementById('prospect-status').value = prospect.status || 'new';
            document.getElementById('prospect-value').value = prospect.value || '';
            document.getElementById('prospect-next-action').value = prospect.nextAction || '';
            document.getElementById('prospect-notes').value = prospect.notes || '';
            
            document.getElementById('prospect-form').dataset.editId = id;
            document.querySelector('#modal-prospect .modal-title').textContent = 'Modifier le prospect';
            
            openModal('prospect');
        }

        function deleteProspect(id) {
            if (confirm('Supprimer ce prospect ?')) {
                data.prospects = data.prospects.filter(p => p.id !== id);
                saveData();
                renderAllProspects();
                updateProspectStats();
                showToast('Prospect supprim', 'success');
            }
        }

        function convertProspectToClient(id) {
            const prospect = data.prospects.find(p => p.id === id);
            if (!prospect) return;
            
            if (confirm(`Convertir "${prospect.name}" en client ?`)) {
                // Create new client from prospect
                const newClient = {
                    id: Math.max(0, ...data.clients.map(c => c.id)) + 1,
                    name: prospect.name,
                    email: prospect.email || '',
                    phone: prospect.phone || '',
                    siret: '',
                    address: '',
                    zip: '',
                    city: ''
                };
                
                data.clients.push(newClient);
                
                // Update prospect status
                prospect.status = 'converted';
                
                saveData();
                renderAllProspects();
                updateProspectStats();
                showToast(`${prospect.name} converti en client !`, 'success');
            }
        }

        function openProspectEmailModal(id) {
            const prospect = data.prospects.find(p => p.id === id);
            if (!prospect) return;
            
            const company = data.settings;
            
            document.getElementById('email-doc-title').textContent = `Prospect: ${prospect.name}`;
            document.getElementById('email-doc-subtitle').textContent = prospect.contact ? `Contact: ${prospect.contact}` : 'Prospection commerciale';
            document.getElementById('email-to').value = prospect.email || '';
            document.getElementById('email-subject').value = `${company.companyName || 'AVA Facturation'} - Proposition commerciale`;
            document.getElementById('email-body').value = `Bonjour${prospect.contact ? ' ' + prospect.contact : ''},\n\nJe me permets de vous contacter suite  notre rcent change.\n\nJe serais ravi de discuter de vos besoins et de vous prsenter nos solutions.\n\nRestant  votre disposition,\n\nCordialement,\n${company.companyName || 'AVA Facturation'}`;
            
            document.getElementById('modal-overlay').classList.add('active');
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            document.getElementById('modal-email').style.display = 'block';
        }

        // ========== EXCEL IMPORT ==========
        let importedProspects = [];

        // Drag and drop handlers
        const dropZone = document.getElementById('import-drop-zone');
        if (dropZone) {
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--apple-blue)';
                dropZone.style.background = 'rgba(0, 122, 255, 0.05)';
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--apple-gray-4)';
                dropZone.style.background = 'transparent';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--apple-gray-4)';
                dropZone.style.background = 'transparent';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processExcelFile(files[0]);
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processExcelFile(file);
            }
        }

        function processExcelFile(file) {
            const validTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-excel',
                'text/csv'
            ];
            
            const extension = file.name.split('.').pop().toLowerCase();
            if (!['xlsx', 'xls', 'csv'].includes(extension)) {
                showToast('Format de fichier non support', 'error');
                return;
            }
            
            document.getElementById('import-file-name').style.display = 'block';
            document.getElementById('import-file-label').textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    parseProspectsFromExcel(jsonData);
                } catch (error) {
                    console.error('Error parsing Excel:', error);
                    showToast('Erreur lors de la lecture du fichier', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseProspectsFromExcel(rows) {
            importedProspects = [];
            
            if (rows.length < 2) {
                showToast('Fichier vide ou sans donnes', 'error');
                return;
            }
            
            // Get headers (first row)
            const headers = rows[0].map(h => String(h || '').toLowerCase().trim());
            
            // Map column indices
            const colMap = {
                name: findColumnIndex(headers, ['entreprise', 'nom', 'socit', 'company', 'name', 'societe']),
                contact: findColumnIndex(headers, ['contact', 'interlocuteur', 'personne', 'nom contact']),
                email: findColumnIndex(headers, ['email', 'mail', 'e-mail', 'courriel']),
                phone: findColumnIndex(headers, ['tlphone', 'telephone', 'tel', 'phone', 'mobile', 'portable']),
                source: findColumnIndex(headers, ['source', 'origine', 'provenance', 'canal']),
                notes: findColumnIndex(headers, ['notes', 'commentaire', 'remarque', 'description', 'commentaires']),
                value: findColumnIndex(headers, ['valeur', 'montant', 'value', 'budget', 'ca'])
            };
            
            // Parse data rows
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length === 0) continue;
                
                const name = colMap.name !== -1 ? String(row[colMap.name] || '').trim() : '';
                if (!name) continue; // Skip rows without a name
                
                importedProspects.push({
                    name: name,
                    contact: colMap.contact !== -1 ? String(row[colMap.contact] || '').trim() : '',
                    email: colMap.email !== -1 ? String(row[colMap.email] || '').trim() : '',
                    phone: colMap.phone !== -1 ? String(row[colMap.phone] || '').trim() : '',
                    source: mapSource(colMap.source !== -1 ? String(row[colMap.source] || '').trim() : ''),
                    notes: colMap.notes !== -1 ? String(row[colMap.notes] || '').trim() : '',
                    value: colMap.value !== -1 ? parseFloat(row[colMap.value]) || 0 : 0
                });
            }
            
            // Update preview
            updateImportPreview();
        }

        function findColumnIndex(headers, possibleNames) {
            for (const name of possibleNames) {
                const idx = headers.findIndex(h => h.includes(name));
                if (idx !== -1) return idx;
            }
            return -1;
        }

        function mapSource(sourceStr) {
            const s = sourceStr.toLowerCase();
            if (s.includes('linkedin')) return 'linkedin';
            if (s.includes('site') || s.includes('web')) return 'website';
            if (s.includes('recomm') || s.includes('referral') || s.includes('parrain')) return 'referral';
            if (s.includes('salon') || s.includes('event') || s.includes('vnement')) return 'event';
            if (s.includes('pub') || s.includes('ads')) return 'ads';
            if (s.includes('prospect') || s.includes('cold') || s.includes('froid')) return 'cold';
            return 'other';
        }

        function updateImportPreview() {
            const previewDiv = document.getElementById('import-preview');
            const tbody = document.getElementById('import-preview-body');
            const countSpan = document.getElementById('import-count');
            const importBtn = document.getElementById('import-btn');
            
            if (importedProspects.length === 0) {
                previewDiv.style.display = 'none';
                importBtn.disabled = true;
                return;
            }
            
            previewDiv.style.display = 'block';
            countSpan.textContent = importedProspects.length;
            importBtn.disabled = false;
            
            // Show first 5 prospects
            const preview = importedProspects.slice(0, 5);
            tbody.innerHTML = preview.map(p => `
                <tr>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.contact || '-'}</td>
                    <td>${p.email || '-'}</td>
                </tr>
            `).join('');
            
            if (importedProspects.length > 5) {
                tbody.innerHTML += `<tr><td colspan="3" style="text-align: center; color: var(--text-secondary);">... et ${importedProspects.length - 5} autres</td></tr>`;
            }
        }

        function clearImportFile() {
            document.getElementById('import-file-input').value = '';
            document.getElementById('import-file-name').style.display = 'none';
            document.getElementById('import-preview').style.display = 'none';
            document.getElementById('import-btn').disabled = true;
            importedProspects = [];
        }

        function importProspects() {
            if (importedProspects.length === 0) {
                showToast('Aucun prospect  importer', 'error');
                return;
            }
            
            const defaultStatus = document.getElementById('import-default-status').value;
            const today = new Date().toISOString().split('T')[0];
            
            if (!data.prospects) data.prospects = [];
            
            let imported = 0;
            importedProspects.forEach(p => {
                // Check for duplicates by email or name
                const exists = data.prospects.some(existing => 
                    (p.email && existing.email === p.email) || 
                    (existing.name.toLowerCase() === p.name.toLowerCase())
                );
                
                if (!exists) {
                    data.prospects.push({
                        id: Date.now() + imported,
                        name: p.name,
                        contact: p.contact,
                        email: p.email,
                        phone: p.phone,
                        source: p.source,
                        status: defaultStatus,
                        value: p.value,
                        nextAction: '',
                        notes: p.notes,
                        createdAt: today
                    });
                    imported++;
                }
            });
            
            saveData();
            closeModal();
            clearImportFile();
            refreshPage('prospection');
            
            const skipped = importedProspects.length - imported;
            if (skipped > 0) {
                showToast(`${imported} prospects imports (${skipped} doublons ignors)`, 'success');
            } else {
                showToast(`${imported} prospects imports avec succs`, 'success');
            }
        }

        function downloadProspectTemplate() {
            // Create template data
            const templateData = [
                ['Entreprise', 'Contact', 'Email', 'Tlphone', 'Source', 'Valeur', 'Notes'],
                ['Exemple SARL', 'Jean Dupont', 'contact@exemple.fr', '01 23 45 67 89', 'LinkedIn', '5000', 'Prospect chaud'],
                ['Socit ABC', 'Marie Martin', 'marie@abc.com', '06 12 34 56 78', 'Site web', '3500', ' relancer']
            ];
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 20 }, // Entreprise
                { wch: 18 }, // Contact
                { wch: 25 }, // Email
                { wch: 18 }, // Tlphone
                { wch: 12 }, // Source
                { wch: 10 }, // Valeur
                { wch: 30 }  // Notes
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Prospects');
            
            // Download
            XLSX.writeFile(wb, 'modele_prospects.xlsx');
            showToast('Modle tlcharg', 'success');
        }

        // ========== HELPERS ==========
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function getStatusBadge(status) {
            const badges = {
                paid: '<span class="badge badge-success">Paye</span>',
                pending: '<span class="badge badge-warning">En attente</span>',
                late: '<span class="badge badge-danger">En retard</span>'
            };
            return badges[status] || badges.pending;
        }

        function getQuoteStatusBadge(status) {
            const badges = {
                accepted: '<span class="badge badge-success">Accept</span>',
                pending: '<span class="badge badge-warning">En attente</span>',
                refused: '<span class="badge badge-danger">Refus</span>'
            };
            return badges[status] || badges.pending;
        }

        function getPaymentMethodLabel(method) {
            const methods = { virement: 'Virement', cheque: 'Chque', carte: 'Carte', especes: 'Espces' };
            return methods[method] || method;
        }

        // ========== MODALS ==========
        function openModal(type) {
            document.getElementById('modal-overlay').classList.add('active');
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            document.getElementById(`modal-${type}`).style.display = 'block';
            
            if (type === 'invoice') {
                populateClientSelect('invoice');
                document.getElementById('invoice-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('invoice-prefix').value = data.invoicePrefix || 'FAC-';
                document.getElementById('invoice-number').value = data.nextInvoiceNum || 1;
                updateInvoiceNumberPreview();
                document.getElementById('invoice-items').innerHTML = '';
                addInvoiceItem();
            } else if (type === 'quote') {
                populateClientSelect('quote');
                document.getElementById('quote-items').innerHTML = '';
                addQuoteItem();
            } else if (type === 'import-prospects') {
                clearImportFile();
            } else if (type === 'user') {
                // Reset user form
                document.getElementById('user-form').reset();
                document.getElementById('user-edit-id').value = '';
                document.getElementById('user-modal-title').textContent = 'Nouvel utilisateur';
                document.getElementById('user-submit-btn').textContent = 'Crer l\'utilisateur';
            }
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        function populateClientSelect(type) {
            const select = document.getElementById(`${type}-client`);
            select.innerHTML = '<option value="">Slectionner un client</option>' +
                data.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        // ========== INVOICE ITEMS ==========
        let invoiceItemCount = 0;
        function addInvoiceItem() {
            const container = document.getElementById('invoice-items');
            const id = invoiceItemCount++;
            const productOptions = data.products.map(p => `<option value="${p.id}" data-price="${p.price}" data-vat="${p.vat}">${p.ref} - ${p.name}</option>`).join('');
            
            const row = document.createElement('div');
            row.className = 'item-row';
            row.id = `invoice-item-${id}`;
            row.innerHTML = `
                <select class="item-product" onchange="onProductSelect(this, 'invoice')">
                    <option value="">Slectionner...</option>
                    ${productOptions}
                    <option value="custom">Saisie libre</option>
                </select>
                <input type="number" value="1" min="1" class="item-qty" onchange="updateInvoiceTotal()">
                <input type="number" step="0.01" value="0" class="item-price" onchange="updateInvoiceTotal()">
                <span class="item-total">0.00</span>
                <button type="button" class="remove-item" onclick="removeInvoiceItem(${id})">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            `;
            container.appendChild(row);
            updateInvoiceTotal();
        }

        function removeInvoiceItem(id) {
            document.getElementById(`invoice-item-${id}`)?.remove();
            updateInvoiceTotal();
        }

        function onProductSelect(select, type) {
            const row = select.closest('.item-row');
            const priceInput = row.querySelector('.item-price');
            
            if (select.value && select.value !== 'custom') {
                const option = select.options[select.selectedIndex];
                priceInput.value = option.dataset.price;
                priceInput.readOnly = true;
            } else {
                priceInput.value = 0;
                priceInput.readOnly = false;
            }
            
            type === 'invoice' ? updateInvoiceTotal() : updateQuoteTotal();
        }

        function updateInvoiceNumberPreview() {
            const prefix = document.getElementById('invoice-prefix').value || 'FAC-';
            const num = parseInt(document.getElementById('invoice-number').value) || 1;
            const preview = `${prefix}${String(num).padStart(3, '0')}`;
            document.getElementById('invoice-number-preview').textContent = `Aperu : ${preview}`;
        }

        function updateInvoiceTotal() {
            let totalHT = 0, totalVAT = 0;
            document.querySelectorAll('#invoice-items .item-row').forEach(row => {
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const select = row.querySelector('.item-product');
                let vat = 20;
                if (select.value && select.value !== 'custom') {
                    vat = parseFloat(select.options[select.selectedIndex].dataset.vat) || 20;
                }
                const ht = qty * price;
                const ttc = ht * (1 + vat / 100);
                row.querySelector('.item-total').textContent = `${ttc.toFixed(2)}`;
                totalHT += ht;
                totalVAT += ht * (vat / 100);
            });
            document.getElementById('invoice-subtotal').textContent = `${totalHT.toFixed(2)}`;
            document.getElementById('invoice-vat').textContent = `${totalVAT.toFixed(2)}`;
            document.getElementById('invoice-total').textContent = `${(totalHT + totalVAT).toFixed(2)}`;
        }

        // Quote items
        let quoteItemCount = 0;
        function addQuoteItem() {
            const container = document.getElementById('quote-items');
            const id = quoteItemCount++;
            const productOptions = data.products.map(p => `<option value="${p.id}" data-price="${p.price}" data-vat="${p.vat}">${p.ref} - ${p.name}</option>`).join('');
            
            const row = document.createElement('div');
            row.className = 'item-row';
            row.id = `quote-item-${id}`;
            row.innerHTML = `
                <select class="item-product" onchange="onProductSelect(this, 'quote')">
                    <option value="">Slectionner...</option>
                    ${productOptions}
                    <option value="custom">Saisie libre</option>
                </select>
                <input type="number" value="1" min="1" class="item-qty" onchange="updateQuoteTotal()">
                <input type="number" step="0.01" value="0" class="item-price" onchange="updateQuoteTotal()">
                <span class="item-total">0.00</span>
                <button type="button" class="remove-item" onclick="removeQuoteItem(${id})">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            `;
            container.appendChild(row);
        }

        function removeQuoteItem(id) {
            document.getElementById(`quote-item-${id}`)?.remove();
            updateQuoteTotal();
        }

        function updateQuoteTotal() {
            let total = 0;
            document.querySelectorAll('#quote-items .item-row').forEach(row => {
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const select = row.querySelector('.item-product');
                let vat = 20;
                if (select.value && select.value !== 'custom') {
                    vat = parseFloat(select.options[select.selectedIndex].dataset.vat) || 20;
                }
                const ttc = qty * price * (1 + vat / 100);
                row.querySelector('.item-total').textContent = `${ttc.toFixed(2)}`;
                total += ttc;
            });
            document.getElementById('quote-total').textContent = `${total.toFixed(2)}`;
        }

        // ========== FORM HANDLERS ==========
        document.getElementById('invoice-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const clientId = parseInt(document.getElementById('invoice-client').value);
            const date = document.getElementById('invoice-date').value;
            const paymentMethod = document.getElementById('invoice-payment-method').value;
            const paymentDelay = parseInt(document.getElementById('invoice-payment-delay').value);
            const invoicePrefix = document.getElementById('invoice-prefix').value || 'FAC-';
            const invoiceNum = parseInt(document.getElementById('invoice-number').value) || data.nextInvoiceNum;
            const recurring = document.getElementById('invoice-recurring').value;
            const recurringEnd = document.getElementById('invoice-recurring-end').value;
            
            const items = [];
            let totalHT = 0, totalTTC = 0;
            document.querySelectorAll('#invoice-items .item-row').forEach(row => {
                const select = row.querySelector('.item-product');
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                let vat = 20, desc = 'Article';
                if (select.value && select.value !== 'custom') {
                    const p = data.products.find(x => x.id == select.value);
                    if (p) { desc = p.name; vat = p.vat; }
                }
                const ht = qty * price;
                totalHT += ht;
                totalTTC += ht * (1 + vat / 100);
                items.push({ desc, qty, price, vat });
            });
            
            const dueDate = new Date(date);
            dueDate.setDate(dueDate.getDate() + paymentDelay);
            
            // Save prefix for future invoices
            data.invoicePrefix = invoicePrefix;
            // Update next invoice number (increment from current)
            data.nextInvoiceNum = invoiceNum + 1;
            
            const newInvoice = {
                id: Date.now(),
                number: `${invoicePrefix}${String(invoiceNum).padStart(3, '0')}`,
                clientId, date,
                dueDate: dueDate.toISOString().split('T')[0],
                paymentMethod, paymentDelay,
                items, totalHT, total: totalTTC,
                status: 'pending'
            };
            
            // Add recurring info if set
            if (recurring) {
                newInvoice.recurring = recurring;
                newInvoice.recurringEnd = recurringEnd || null;
                newInvoice.nextRecurringDate = calculateNextRecurringDate(date, recurring);
            }
            
            data.invoices.push(newInvoice);
            saveData();
            closeModal();
            refreshPage('dashboard');
            showToast(recurring ? 'Facture rcurrente cre' : 'Facture cre avec succs', 'success');
        });
        
        function toggleRecurringEnd() {
            const recurring = document.getElementById('invoice-recurring').value;
            const endGroup = document.getElementById('recurring-end-group');
            endGroup.style.display = recurring ? 'block' : 'none';
        }
        
        function calculateNextRecurringDate(fromDate, frequency) {
            const date = new Date(fromDate);
            switch(frequency) {
                case 'monthly': date.setMonth(date.getMonth() + 1); break;
                case 'quarterly': date.setMonth(date.getMonth() + 3); break;
                case 'yearly': date.setFullYear(date.getFullYear() + 1); break;
            }
            return date.toISOString().split('T')[0];
        }
        
        function generateRecurringInvoices() {
            const today = new Date().toISOString().split('T')[0];
            let generated = 0;
            
            data.invoices.forEach(inv => {
                if (!inv.recurring || !inv.nextRecurringDate) return;
                if (inv.recurringEnd && inv.nextRecurringDate > inv.recurringEnd) return;
                if (inv.nextRecurringDate > today) return;
                
                // Generate new invoice
                const num = data.nextInvoiceNum++;
                const prefix = data.invoicePrefix || 'FAC-';
                const dueDate = new Date(inv.nextRecurringDate);
                dueDate.setDate(dueDate.getDate() + inv.paymentDelay);
                
                const newInvoice = {
                    id: Date.now() + generated,
                    number: `${prefix}${String(num).padStart(3, '0')}`,
                    clientId: inv.clientId,
                    date: inv.nextRecurringDate,
                    dueDate: dueDate.toISOString().split('T')[0],
                    paymentMethod: inv.paymentMethod,
                    paymentDelay: inv.paymentDelay,
                    items: [...inv.items],
                    totalHT: inv.totalHT,
                    total: inv.total,
                    status: 'pending',
                    recurring: inv.recurring,
                    recurringEnd: inv.recurringEnd,
                    nextRecurringDate: calculateNextRecurringDate(inv.nextRecurringDate, inv.recurring),
                    generatedFrom: inv.id
                };
                
                data.invoices.push(newInvoice);
                
                // Update original invoice's next date
                inv.nextRecurringDate = calculateNextRecurringDate(inv.nextRecurringDate, inv.recurring);
                generated++;
            });
            
            if (generated > 0) {
                saveData();
                showToast(`${generated} facture(s) rcurrente(s) gnre(s)`, 'success');
            }
            
            return generated;
        }

        document.getElementById('quote-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const clientId = parseInt(document.getElementById('quote-client').value);
            const validity = parseInt(document.getElementById('quote-validity').value);
            
            const items = [];
            let total = 0;
            document.querySelectorAll('#quote-items .item-row').forEach(row => {
                const select = row.querySelector('.item-product');
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                let vat = 20, desc = 'Article';
                if (select.value && select.value !== 'custom') {
                    const p = data.products.find(x => x.id == select.value);
                    if (p) { desc = p.name; vat = p.vat; }
                }
                total += qty * price * (1 + vat / 100);
                items.push({ desc, qty, price, vat });
            });
            
            data.quotes.push({
                id: Date.now(),
                number: `DEV-${String(data.nextQuoteNum++).padStart(3, '0')}`,
                clientId,
                date: new Date().toISOString().split('T')[0],
                validity, items, total,
                status: 'pending'
            });
            saveData();
            closeModal();
            refreshPage('devis');
            showToast('Devis cr avec succs', 'success');
        });

        document.getElementById('client-form').addEventListener('submit', (e) => {
            e.preventDefault();
            data.clients.push({
                id: Date.now(),
                name: document.getElementById('client-name').value,
                email: document.getElementById('client-email').value,
                phone: document.getElementById('client-phone').value,
                siret: document.getElementById('client-siret').value,
                address: document.getElementById('client-address').value,
                zip: document.getElementById('client-zip').value,
                city: document.getElementById('client-city').value
            });
            saveData();
            closeModal();
            refreshPage('clients');
            showToast('Client ajout', 'success');
            e.target.reset();
        });

        document.getElementById('product-form').addEventListener('submit', (e) => {
            e.preventDefault();
            data.products.push({
                id: Date.now(),
                ref: document.getElementById('product-ref').value,
                name: document.getElementById('product-name').value,
                price: parseFloat(document.getElementById('product-price').value),
                vat: parseFloat(document.getElementById('product-vat').value)
            });
            saveData();
            closeModal();
            refreshPage('produits');
            showToast('Produit ajout', 'success');
            e.target.reset();
        });

        document.getElementById('prospect-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const editId = e.target.dataset.editId;
            
            const prospectData = {
                name: document.getElementById('prospect-name').value,
                contact: document.getElementById('prospect-contact').value,
                email: document.getElementById('prospect-email').value,
                phone: document.getElementById('prospect-phone').value,
                source: document.getElementById('prospect-source').value,
                status: document.getElementById('prospect-status').value,
                value: parseFloat(document.getElementById('prospect-value').value) || 0,
                nextAction: document.getElementById('prospect-next-action').value,
                notes: document.getElementById('prospect-notes').value
            };
            
            if (editId) {
                // Edit existing prospect
                const idx = data.prospects.findIndex(p => p.id === parseInt(editId));
                if (idx !== -1) {
                    data.prospects[idx] = { ...data.prospects[idx], ...prospectData };
                }
                delete e.target.dataset.editId;
                document.querySelector('#modal-prospect .modal-title').textContent = 'Nouveau prospect';
                showToast('Prospect modifi', 'success');
            } else {
                // Add new prospect
                if (!data.prospects) data.prospects = [];
                if (!data.nextProspectNum) data.nextProspectNum = 1;
                
                data.prospects.push({
                    id: Date.now(),
                    ...prospectData,
                    createdAt: new Date().toISOString().split('T')[0]
                });
                data.nextProspectNum++;
                showToast('Prospect ajout', 'success');
            }
            
            saveData();
            closeModal();
            refreshPage('prospection');
            e.target.reset();
        });

        document.getElementById('settings-form').addEventListener('submit', (e) => {
            e.preventDefault();
            data.settings = {
                companyName: document.getElementById('company-name').value,
                siret: document.getElementById('company-siret').value,
                address: document.getElementById('company-address').value,
                zip: document.getElementById('company-zip').value,
                city: document.getElementById('company-city').value,
                email: document.getElementById('company-email').value,
                phone: document.getElementById('company-phone').value,
                iban: document.getElementById('company-iban').value
            };
            saveData();
            showToast('Paramtres enregistrs', 'success');
        });

        function loadSettings() {
            const s = data.settings;
            document.getElementById('company-name').value = s.companyName || '';
            document.getElementById('company-siret').value = s.siret || '';
            document.getElementById('company-address').value = s.address || '';
            document.getElementById('company-zip').value = s.zip || '';
            document.getElementById('company-city').value = s.city || '';
            document.getElementById('company-email').value = s.email || '';
            document.getElementById('company-phone').value = s.phone || '';
            document.getElementById('company-iban').value = s.iban || '';
        }

        function resetSettings() {
            if (confirm('Rinitialiser les paramtres ?')) {
                data.settings = {};
                saveData();
                loadSettings();
                showToast('Paramtres rinitialiss', 'success');
            }
        }

        // ========== PAYMENT ==========
        function openPaymentModal(id) {
            const inv = data.invoices.find(i => i.id === id);
            if (!inv) return;
            const client = data.clients.find(c => c.id === inv.clientId);
            
            document.getElementById('payment-invoice-id').value = id;
            document.getElementById('payment-invoice-number').textContent = inv.number;
            document.getElementById('payment-invoice-client').textContent = client ? client.name : 'Inconnu';
            document.getElementById('payment-invoice-amount').textContent = `${inv.total.toFixed(2)}`;
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('payment-method').value = inv.paymentMethod || 'virement';
            document.getElementById('payment-reference').value = '';
            
            document.getElementById('modal-overlay').classList.add('active');
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            document.getElementById('modal-payment').style.display = 'block';
        }

        document.getElementById('payment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = parseInt(document.getElementById('payment-invoice-id').value);
            const inv = data.invoices.find(i => i.id === id);
            if (!inv) return;
            
            inv.status = 'paid';
            inv.paidDate = document.getElementById('payment-date').value;
            inv.paidMethod = document.getElementById('payment-method').value;
            inv.paidReference = document.getElementById('payment-reference').value;
            
            saveData();
            closeModal();
            refreshPage('dashboard');
            refreshPage('factures');
            showToast('Paiement enregistr', 'success');
        });

        // ========== PREVIEW & PDF ==========
        function viewInvoice(id) {
            const inv = data.invoices.find(i => i.id === id);
            if (!inv) return;
            currentPreviewInvoice = inv;
            currentPreviewType = 'invoice';
            
            const client = data.clients.find(c => c.id === inv.clientId);
            const company = data.settings;
            
            let itemsHTML = inv.items.map(item => {
                const ttc = item.qty * item.price * (1 + (item.vat || 20) / 100);
                return `<tr><td>${item.desc}</td><td style="text-align:center">${item.qty}</td><td style="text-align:right">${item.price.toFixed(2)}</td><td style="text-align:center">${item.vat || 20}%</td><td>${ttc.toFixed(2)}</td></tr>`;
            }).join('');
            
            let totalHT = inv.items.reduce((sum, i) => sum + i.qty * i.price, 0);
            let totalVAT = inv.items.reduce((sum, i) => sum + i.qty * i.price * ((i.vat || 20) / 100), 0);
            
            let paymentHTML = '';
            if (inv.status === 'paid') {
                paymentHTML = `<div class="payment-status-card paid"><div class="payment-status-header"><div class="payment-status-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></div><div class="payment-status-title">Paye le ${formatDate(inv.paidDate)}</div></div><div class="payment-status-details"><p><strong>Mode :</strong> <span class="payment-method-tag">${getPaymentMethodLabel(inv.paidMethod)}</span></p></div></div>`;
            } else if (inv.status === 'late') {
                paymentHTML = `<div class="payment-status-card late"><div class="payment-status-header"><div class="payment-status-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div><div class="payment-status-title">Paiement en retard</div></div></div>`;
            } else {
                paymentHTML = `<div class="payment-status-card pending"><div class="payment-status-header"><div class="payment-status-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div><div class="payment-status-title">En attente de paiement</div></div></div>`;
            }
            
            document.getElementById('invoice-document').innerHTML = `
                <div class="invoice-doc-header">
                    <div class="invoice-doc-brand">
                        <h1>${company.companyName || 'AVA Facturation'}</h1>
                        ${company.address ? `<p>${company.address}</p>` : ''}
                        ${company.zip || company.city ? `<p>${company.zip || ''} ${company.city || ''}</p>` : ''}
                        ${company.email ? `<p>${company.email}</p>` : ''}
                        ${company.phone ? `<p>${company.phone}</p>` : ''}
                    </div>
                    <div class="invoice-doc-info">
                        <div class="invoice-doc-number">${inv.number}</div>
                        <p><strong>Date :</strong> ${formatDate(inv.date)}</p>
                        <p><strong>chance :</strong> ${formatDate(inv.dueDate)}</p>
                    </div>
                </div>
                <div class="invoice-doc-parties">
                    <div class="invoice-doc-party">
                        <h4>metteur</h4>
                        <div class="invoice-doc-party-name">${company.companyName || 'AVA Facturation'}</div>
                        ${company.siret ? `<p>SIRET : ${company.siret}</p>` : ''}
                    </div>
                    <div class="invoice-doc-party" style="text-align:right">
                        <h4>Client</h4>
                        <div class="invoice-doc-party-name">${client ? client.name : 'Client'}</div>
                        ${client?.address ? `<p>${client.address}</p>` : ''}
                        ${client?.zip || client?.city ? `<p>${client.zip || ''} ${client.city || ''}</p>` : ''}
                        ${client?.email ? `<p>${client.email}</p>` : ''}
                    </div>
                </div>
                <table class="invoice-doc-table">
                    <thead><tr><th>Description</th><th style="text-align:center">Qt</th><th style="text-align:right">Prix HT</th><th style="text-align:center">TVA</th><th style="text-align:right">Total TTC</th></tr></thead>
                    <tbody>${itemsHTML}</tbody>
                </table>
                <div class="invoice-doc-totals">
                    <div class="invoice-doc-totals-table">
                        <div class="invoice-doc-totals-row"><span>Total HT</span><span>${totalHT.toFixed(2)}</span></div>
                        <div class="invoice-doc-totals-row"><span>TVA</span><span>${totalVAT.toFixed(2)}</span></div>
                        <div class="invoice-doc-totals-row total"><span>Total TTC</span><span>${(totalHT + totalVAT).toFixed(2)}</span></div>
                    </div>
                </div>
                ${paymentHTML}
                <div class="invoice-doc-footer">
                    <h4>Conditions de paiement</h4>
                    <p>Paiement par ${getPaymentMethodLabel(inv.paymentMethod || 'virement').toLowerCase()} sous ${inv.paymentDelay || 30} jours.</p>
                    ${company.iban ? `<div class="invoice-doc-bank"><h4>Coordonnes bancaires</h4><p><strong>IBAN :</strong> ${company.iban}</p></div>` : ''}
                </div>
            `;
            
            document.getElementById('preview-title').textContent = inv.number;
            document.getElementById('modal-overlay').classList.add('active');
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            document.getElementById('modal-preview').style.display = 'block';
        }

        function printInvoice() { window.print(); }

        function downloadPDF() {
            const el = document.getElementById('invoice-document');
            const num = currentPreviewInvoice ? currentPreviewInvoice.number : 'facture';
            showToast('Gnration du PDF...', '');
            html2pdf().set({
                margin: 10,
                filename: `${num}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(el).save().then(() => showToast('PDF tlcharg', 'success'));
        }

        function quickDownloadPDF(id) {
            viewInvoice(id);
            setTimeout(downloadPDF, 300);
        }

        function viewQuote(id) {
            const quote = data.quotes.find(q => q.id === id);
            if (!quote) return;
            currentPreviewQuote = quote;
            currentPreviewType = 'quote';
            
            const client = data.clients.find(c => c.id === quote.clientId);
            const company = data.settings;
            
            let itemsHTML = quote.items.map(item => {
                const ttc = item.qty * item.price * (1 + (item.vat || 20) / 100);
                return `<tr><td>${item.desc}</td><td style="text-align:center">${item.qty}</td><td style="text-align:right">${item.price.toFixed(2)}</td><td style="text-align:center">${item.vat || 20}%</td><td>${ttc.toFixed(2)}</td></tr>`;
            }).join('');
            
            let totalHT = quote.items.reduce((sum, i) => sum + i.qty * i.price, 0);
            let totalVAT = quote.items.reduce((sum, i) => sum + i.qty * i.price * ((i.vat || 20) / 100), 0);
            
            document.getElementById('invoice-document').innerHTML = `
                <div class="invoice-doc-header">
                    <div class="invoice-doc-brand">
                        <h1>${company.companyName || 'AVA Facturation'}</h1>
                        ${company.address ? `<p>${company.address}</p>` : ''}
                        ${company.zip || company.city ? `<p>${company.zip || ''} ${company.city || ''}</p>` : ''}
                        ${company.email ? `<p>${company.email}</p>` : ''}
                        ${company.phone ? `<p>${company.phone}</p>` : ''}
                    </div>
                    <div class="invoice-doc-info">
                        <div class="invoice-doc-number" style="background: linear-gradient(135deg, var(--apple-purple), var(--apple-blue));">${quote.number}</div>
                        <p><strong>Date :</strong> ${formatDate(quote.date)}</p>
                        <p><strong>Validit :</strong> ${quote.validity} jours</p>
                    </div>
                </div>
                <div class="invoice-doc-parties">
                    <div class="invoice-doc-party">
                        <h4>metteur</h4>
                        <div class="invoice-doc-party-name">${company.companyName || 'AVA Facturation'}</div>
                        ${company.siret ? `<p>SIRET : ${company.siret}</p>` : ''}
                    </div>
                    <div class="invoice-doc-party" style="text-align:right">
                        <h4>Client</h4>
                        <div class="invoice-doc-party-name">${client ? client.name : 'Client'}</div>
                        ${client?.address ? `<p>${client.address}</p>` : ''}
                        ${client?.zip || client?.city ? `<p>${client.zip || ''} ${client.city || ''}</p>` : ''}
                        ${client?.email ? `<p>${client.email}</p>` : ''}
                    </div>
                </div>
                <table class="invoice-doc-table">
                    <thead><tr><th>Description</th><th style="text-align:center">Qt</th><th style="text-align:right">Prix HT</th><th style="text-align:center">TVA</th><th style="text-align:right">Total TTC</th></tr></thead>
                    <tbody>${itemsHTML}</tbody>
                </table>
                <div class="invoice-doc-totals">
                    <div class="invoice-doc-totals-table">
                        <div class="invoice-doc-totals-row"><span>Total HT</span><span>${totalHT.toFixed(2)}</span></div>
                        <div class="invoice-doc-totals-row"><span>TVA</span><span>${totalVAT.toFixed(2)}</span></div>
                        <div class="invoice-doc-totals-row total"><span>Total TTC</span><span>${(totalHT + totalVAT).toFixed(2)}</span></div>
                    </div>
                </div>
                <div class="invoice-doc-footer">
                    <h4>Conditions</h4>
                    <p>Ce devis est valable ${quote.validity} jours  compter de sa date d'mission.</p>
                    <p style="margin-top: 12px; font-style: italic; color: var(--text-secondary);">Pour accepter ce devis, veuillez nous le retourner sign avec la mention "Bon pour accord".</p>
                </div>
            `;
            
            document.getElementById('preview-title').textContent = quote.number;
            document.getElementById('modal-overlay').classList.add('active');
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            document.getElementById('modal-preview').style.display = 'block';
        }

        // ========== EMAIL FUNCTIONS ==========
        function openEmailModal(id, type, isReminder = false) {
            let doc, client, docTitle, docSubtitle, subject, body;
            const company = data.settings;
            
            if (type === 'invoice') {
                doc = data.invoices.find(i => i.id === id);
                if (!doc) return;
                client = data.clients.find(c => c.id === doc.clientId);
                docTitle = `Facture ${doc.number}`;
                docSubtitle = `Montant : ${doc.total.toLocaleString()} TTC`;
                
                if (isReminder || doc.status === 'late') {
                    // Reminder email for late invoice
                    subject = `${company.companyName || 'AVA Facturation'} - Rappel : Facture ${doc.number} en attente`;
                    body = `Bonjour,\n\nNous nous permettons de vous relancer concernant la facture ${doc.number} d'un montant de ${doc.total.toLocaleString()} TTC.\n\nDate d'chance : ${formatDate(doc.dueDate)}\n\nNous vous remercions de bien vouloir procder au rglement dans les meilleurs dlais.\n\nSi le paiement a dj t effectu, merci de ne pas tenir compte de ce message.\n\nCordialement,\n${company.companyName || 'AVA Facturation'}`;
                } else {
                    subject = `${company.companyName || 'AVA Facturation'} - Facture ${doc.number}`;
                    body = `Bonjour,\n\nVeuillez trouver ci-joint la facture ${doc.number} d'un montant de ${doc.total.toLocaleString()} TTC.\n\nDate d'chance : ${formatDate(doc.dueDate)}\n\nNous restons  votre disposition pour toute question.\n\nCordialement,\n${company.companyName || 'AVA Facturation'}`;
                }
            } else {
                doc = data.quotes.find(q => q.id === id);
                if (!doc) return;
                client = data.clients.find(c => c.id === doc.clientId);
                docTitle = `Devis ${doc.number}`;
                docSubtitle = `Montant : ${doc.total.toLocaleString()} TTC`;
                subject = `${company.companyName || 'AVA Facturation'} - Devis ${doc.number}`;
                body = `Bonjour,\n\nVeuillez trouver ci-joint notre devis ${doc.number} d'un montant de ${doc.total.toLocaleString()} TTC.\n\nCe devis est valable ${doc.validity} jours.\n\nNous restons  votre disposition pour toute question.\n\nCordialement,\n${company.companyName || 'AVA Facturation'}`;
            }
            
            document.getElementById('email-doc-title').textContent = docTitle;
            document.getElementById('email-doc-subtitle').textContent = docSubtitle;
            document.getElementById('email-to').value = client?.email || '';
            document.getElementById('email-subject').value = subject;
            document.getElementById('email-body').value = body;
            
            document.getElementById('modal-overlay').classList.add('active');
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            document.getElementById('modal-email').style.display = 'block';
        }
        
        function sendReminder(invoiceId) {
            openEmailModal(invoiceId, 'invoice', true);
        }
        
        function sendAllReminders() {
            const lateInvoices = data.invoices.filter(i => i.status === 'late' || i.status === 'pending');
            if (lateInvoices.length === 0) {
                showToast('Aucune facture en attente', 'info');
                return;
            }
            
            // For each late invoice, prepare mailto links
            const reminderList = lateInvoices.map(inv => {
                const client = data.clients.find(c => c.id === inv.clientId);
                return ` ${inv.number} - ${client?.name || 'Client'} - ${inv.total.toFixed(2)}`;
            }).join('\n');
            
            if (confirm(`Envoyer des relances pour ${lateInvoices.length} facture(s) ?\n\n${reminderList}`)) {
                // Open first reminder
                if (lateInvoices.length > 0) {
                    sendReminder(lateInvoices[0].id);
                    showToast(`${lateInvoices.length} relance(s)  envoyer`, 'success');
                }
            }
        }

        function openEmailFromPreview() {
            if (currentPreviewType === 'invoice' && currentPreviewInvoice) {
                openEmailModal(currentPreviewInvoice.id, 'invoice');
            } else if (currentPreviewType === 'quote' && currentPreviewQuote) {
                openEmailModal(currentPreviewQuote.id, 'quote');
            }
        }

        function sendEmail(e) {
            e.preventDefault();
            const to = document.getElementById('email-to').value;
            const subject = encodeURIComponent(document.getElementById('email-subject').value);
            const body = encodeURIComponent(document.getElementById('email-body').value);
            
            window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
            
            closeModal();
            showToast('Ouverture du client email...', 'success');
        }

        // ========== DELETE FUNCTIONS ==========
        function deleteInvoice(id) {
            if (confirm('Supprimer cette facture ?')) {
                data.invoices = data.invoices.filter(i => i.id !== id);
                saveData();
                refreshPage('dashboard');
                refreshPage('factures');
                showToast('Facture supprime', 'success');
            }
        }

        function deleteQuote(id) {
            if (confirm('Supprimer ce devis ?')) {
                data.quotes = data.quotes.filter(q => q.id !== id);
                saveData();
                refreshPage('devis');
                showToast('Devis supprim', 'success');
            }
        }

        function deleteClient(id) {
            if (confirm('Supprimer ce client ?')) {
                data.clients = data.clients.filter(c => c.id !== id);
                saveData();
                refreshPage('clients');
                showToast('Client supprim', 'success');
            }
        }

        function deleteProduct(id) {
            if (confirm('Supprimer ce produit ?')) {
                data.products = data.products.filter(p => p.id !== id);
                saveData();
                refreshPage('produits');
                showToast('Produit supprim', 'success');
            }
        }

        function convertToInvoice(id) {
            const q = data.quotes.find(x => x.id === id);
            if (q && confirm('Convertir ce devis en facture ?')) {
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 30);
                const prefix = data.invoicePrefix || 'FAC-';
                const num = data.nextInvoiceNum || 1;
                data.invoices.push({
                    id: Date.now(),
                    number: `${prefix}${String(num).padStart(3, '0')}`,
                    clientId: q.clientId,
                    date: new Date().toISOString().split('T')[0],
                    dueDate: dueDate.toISOString().split('T')[0],
                    paymentMethod: 'virement', paymentDelay: 30,
                    items: q.items, total: q.total,
                    status: 'pending'
                });
                data.nextInvoiceNum = num + 1;
                q.status = 'accepted';
                saveData();
                refreshPage('devis');
                showToast('Devis converti en facture', 'success');
            }
        }

        // ========== TOAST ==========
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ========== CLOSE MODAL ON OVERLAY CLICK ==========
        document.getElementById('modal-overlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeModal();
        });

        // ========== CALENDAR ==========
        let currentCalendarDate = new Date();
        
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const months = ['Janvier', 'Fvrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Aot', 'Septembre', 'Octobre', 'Novembre', 'Dcembre'];
            document.getElementById('calendar-month-title').textContent = `${months[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = (firstDay.getDay() + 6) % 7; // Monday = 0
            const daysInMonth = lastDay.getDate();
            
            const today = new Date().toISOString().split('T')[0];
            const events = getCalendarEvents(year, month);
            
            let html = '';
            
            // Previous month days
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                html += `<div class="calendar-day other-month"><span class="calendar-day-number">${day}</span></div>`;
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === today;
                const dayEvents = events.filter(e => e.date === dateStr);
                
                html += `<div class="calendar-day${isToday ? ' today' : ''}" onclick="showDayEvents('${dateStr}')">
                    <span class="calendar-day-number">${day}</span>
                    <div class="calendar-events">
                        ${dayEvents.slice(0, 3).map(e => `<div class="calendar-event ${e.type}">${e.title}</div>`).join('')}
                        ${dayEvents.length > 3 ? `<div class="calendar-event" style="background: var(--apple-gray-5); color: var(--text-secondary);">+${dayEvents.length - 3}</div>` : ''}
                    </div>
                </div>`;
            }
            
            // Next month days
            const totalCells = startDay + daysInMonth;
            const remaining = (7 - (totalCells % 7)) % 7;
            for (let i = 1; i <= remaining; i++) {
                html += `<div class="calendar-day other-month"><span class="calendar-day-number">${i}</span></div>`;
            }
            
            document.getElementById('calendar-grid').innerHTML = html;
            renderUpcomingEvents();
        }
        
        function getCalendarEvents(year, month) {
            const events = [];
            
            // Invoice due dates
            data.invoices.forEach(inv => {
                if (inv.status === 'pending' || inv.status === 'late') {
                    const d = new Date(inv.dueDate);
                    if (d.getFullYear() === year && d.getMonth() === month) {
                        const client = data.clients.find(c => c.id === inv.clientId);
                        events.push({
                            date: inv.dueDate,
                            title: `${inv.number}`,
                            type: inv.status === 'late' ? 'invoice-late' : 'invoice-due',
                            detail: `chance ${inv.number} - ${client?.name || 'Client'} - ${inv.total.toFixed(2)}`
                        });
                    }
                }
            });
            
            // Prospect actions
            (data.prospects || []).forEach(p => {
                if (p.nextAction) {
                    const d = new Date(p.nextAction);
                    if (d.getFullYear() === year && d.getMonth() === month) {
                        events.push({
                            date: p.nextAction,
                            title: p.name,
                            type: 'prospect-action',
                            detail: `Relance ${p.name} - ${p.contact || ''}`
                        });
                    }
                }
            });
            
            // Quote expiry
            (data.quotes || []).forEach(q => {
                if (q.status === 'pending' && q.expiryDate) {
                    const d = new Date(q.expiryDate);
                    if (d.getFullYear() === year && d.getMonth() === month) {
                        const client = data.clients.find(c => c.id === q.clientId);
                        events.push({
                            date: q.expiryDate,
                            title: `${q.number}`,
                            type: 'quote-expiry',
                            detail: `Devis ${q.number} expire - ${client?.name || 'Client'}`
                        });
                    }
                }
            });
            
            return events;
        }
        
        function renderUpcomingEvents() {
            const container = document.getElementById('upcoming-events');
            if (!container) return;
            
            const today = new Date();
            const events = [];
            const months = ['Jan', 'Fv', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aot', 'Sep', 'Oct', 'Nov', 'Dc'];
            
            // Get events for next 30 days
            for (let i = 0; i < 12; i++) {
                const d = new Date(today);
                d.setMonth(d.getMonth() + Math.floor(i / 2));
                const monthEvents = getCalendarEvents(d.getFullYear(), d.getMonth());
                events.push(...monthEvents);
            }
            
            // Filter and sort upcoming events
            const todayStr = today.toISOString().split('T')[0];
            const upcoming = events
                .filter(e => e.date >= todayStr)
                .sort((a, b) => a.date.localeCompare(b.date))
                .slice(0, 10);
            
            if (upcoming.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun vnement  venir</p>';
                return;
            }
            
            container.innerHTML = upcoming.map(e => {
                const d = new Date(e.date);
                const badgeClass = e.type === 'invoice-late' ? 'background: rgba(255, 59, 48, 0.1); color: var(--apple-red);' :
                                   e.type === 'invoice-due' ? 'background: rgba(255, 149, 0, 0.1); color: var(--apple-orange);' :
                                   e.type === 'prospect-action' ? 'background: rgba(175, 82, 222, 0.1); color: var(--apple-purple);' :
                                   'background: rgba(0, 122, 255, 0.1); color: var(--apple-blue);';
                const typeLabel = e.type === 'invoice-late' ? 'En retard' :
                                  e.type === 'invoice-due' ? 'chance' :
                                  e.type === 'prospect-action' ? 'Relance' : 'Devis';
                return `
                    <div class="upcoming-event-item">
                        <div class="upcoming-event-date">
                            <div class="upcoming-event-day">${d.getDate()}</div>
                            <div class="upcoming-event-month">${months[d.getMonth()]}</div>
                        </div>
                        <div class="upcoming-event-info">
                            <div class="upcoming-event-title">${e.detail}</div>
                        </div>
                        <span class="upcoming-event-badge" style="${badgeClass}">${typeLabel}</span>
                    </div>
                `;
            }).join('');
        }
        
        function prevMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }
        
        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }
        
        function goToToday() {
            currentCalendarDate = new Date();
            renderCalendar();
        }
        
        function showDayEvents(dateStr) {
            // Could open a modal with day details
            console.log('Show events for:', dateStr);
        }
        
        // ========== REPORTS ==========
        function updateReports() {
            const period = document.getElementById('report-period')?.value || 'year';
            const now = new Date();
            let startDate, endDate;
            
            switch(period) {
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    endDate = new Date(now.getFullYear(), (quarter + 1) * 3, 0);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    break;
                case 'all':
                default:
                    startDate = new Date(2000, 0, 1);
                    endDate = new Date(2100, 11, 31);
            }
            
            const filteredInvoices = data.invoices.filter(inv => {
                const d = new Date(inv.date);
                return d >= startDate && d <= endDate && inv.status === 'paid';
            });
            
            // Calculate totals
            let totalHT = 0, totalTVA = 0, totalTTC = 0;
            const tvaByRate = {};
            const caByClient = {};
            
            filteredInvoices.forEach(inv => {
                totalTTC += inv.total;
                totalHT += inv.totalHT || 0;
                
                (inv.items || []).forEach(item => {
                    const ht = item.qty * item.price;
                    const vat = item.vat || 20;
                    const tva = ht * (vat / 100);
                    
                    if (!tvaByRate[vat]) {
                        tvaByRate[vat] = { baseHT: 0, montantTVA: 0, count: 0 };
                    }
                    tvaByRate[vat].baseHT += ht;
                    tvaByRate[vat].montantTVA += tva;
                });
                
                if (!caByClient[inv.clientId]) {
                    caByClient[inv.clientId] = { count: 0, totalHT: 0, totalTTC: 0 };
                }
                caByClient[inv.clientId].count++;
                caByClient[inv.clientId].totalHT += inv.totalHT || 0;
                caByClient[inv.clientId].totalTTC += inv.total;
            });
            
            totalTVA = totalTTC - totalHT;
            
            // Update stats
            document.getElementById('report-total-ht').textContent = `${totalHT.toLocaleString()}`;
            document.getElementById('report-total-tva').textContent = `${totalTVA.toLocaleString()}`;
            document.getElementById('report-total-ttc').textContent = `${totalTTC.toLocaleString()}`;
            document.getElementById('report-count').textContent = filteredInvoices.length;
            
            // TVA report table
            const tvaBody = document.getElementById('tva-report-body');
            if (tvaBody) {
                const tvaRows = Object.keys(tvaByRate).sort((a, b) => b - a);
                if (tvaRows.length === 0) {
                    tvaBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">Aucune donne pour cette priode</td></tr>';
                } else {
                    tvaBody.innerHTML = tvaRows.map(rate => {
                        const d = tvaByRate[rate];
                        return `
                            <tr>
                                <td><strong>${rate}%</strong></td>
                                <td>${d.baseHT.toFixed(2)}</td>
                                <td>${d.montantTVA.toFixed(2)}</td>
                                <td>${filteredInvoices.length}</td>
                            </tr>
                        `;
                    }).join('') + `
                        <tr style="font-weight: 600; background: var(--apple-gray-6);">
                            <td>Total</td>
                            <td>${totalHT.toFixed(2)}</td>
                            <td>${totalTVA.toFixed(2)}</td>
                            <td>${filteredInvoices.length}</td>
                        </tr>
                    `;
                }
            }
            
            // Client report table
            const clientBody = document.getElementById('client-report-body');
            if (clientBody) {
                const clientRows = Object.keys(caByClient)
                    .map(clientId => ({ clientId: parseInt(clientId), ...caByClient[clientId] }))
                    .sort((a, b) => b.totalTTC - a.totalTTC);
                
                if (clientRows.length === 0) {
                    clientBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">Aucune donne pour cette priode</td></tr>';
                } else {
                    clientBody.innerHTML = clientRows.map(row => {
                        const client = data.clients.find(c => c.id === row.clientId);
                        const percent = totalTTC > 0 ? ((row.totalTTC / totalTTC) * 100).toFixed(1) : 0;
                        return `
                            <tr>
                                <td><strong>${client?.name || 'Client inconnu'}</strong></td>
                                <td>${row.count}</td>
                                <td>${row.totalHT.toFixed(2)}</td>
                                <td>${row.totalTTC.toFixed(2)}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="flex: 1; height: 6px; background: var(--apple-gray-5); border-radius: 3px;">
                                            <div style="width: ${percent}%; height: 100%; background: var(--apple-blue); border-radius: 3px;"></div>
                                        </div>
                                        <span style="min-width: 45px;">${percent}%</span>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }
        }
        
        function exportTVAReport() {
            const period = document.getElementById('report-period')?.value || 'year';
            let csv = 'Taux TVA;Base HT;Montant TVA\n';
            
            // Get data from table
            const rows = document.querySelectorAll('#tva-report-body tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 3) {
                    csv += `${cells[0].textContent};${cells[1].textContent};${cells[2].textContent}\n`;
                }
            });
            
            downloadCSV(csv, `rapport-tva-${period}.csv`);
            showToast('Rapport TVA export', 'success');
        }
        
        function exportInvoicesCSV() {
            let csv = 'Numro;Date;Client;Total HT;TVA;Total TTC;Statut;Date paiement\n';
            
            data.invoices.forEach(inv => {
                const client = data.clients.find(c => c.id === inv.clientId);
                const tva = inv.total - (inv.totalHT || 0);
                csv += `${inv.number};${inv.date};${client?.name || ''};${inv.totalHT || 0};${tva.toFixed(2)};${inv.total};${inv.status};${inv.paidDate || ''}\n`;
            });
            
            downloadCSV(csv, `factures-${new Date().toISOString().split('T')[0]}.csv`);
            showToast('Factures exportes', 'success');
        }
        
        function exportClientsCSV() {
            let csv = 'Nom;Email;Tlphone;SIRET;Adresse;Code postal;Ville\n';
            
            data.clients.forEach(c => {
                csv += `${c.name};${c.email || ''};${c.phone || ''};${c.siret || ''};${c.address || ''};${c.zip || ''};${c.city || ''}\n`;
            });
            
            downloadCSV(csv, `clients-${new Date().toISOString().split('T')[0]}.csv`);
            showToast('Clients exports', 'success');
        }
        
        function exportFullReport() {
            // Create Excel-compatible export
            const wb = XLSX.utils.book_new();
            
            // Invoices sheet
            const invoicesData = data.invoices.map(inv => {
                const client = data.clients.find(c => c.id === inv.clientId);
                return {
                    'Numro': inv.number,
                    'Date': inv.date,
                    'Client': client?.name || '',
                    'Total HT': inv.totalHT || 0,
                    'Total TTC': inv.total,
                    'Statut': inv.status,
                    'Date paiement': inv.paidDate || ''
                };
            });
            const ws1 = XLSX.utils.json_to_sheet(invoicesData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Factures');
            
            // Clients sheet
            const clientsData = data.clients.map(c => ({
                'Nom': c.name,
                'Email': c.email || '',
                'Tlphone': c.phone || '',
                'SIRET': c.siret || '',
                'Adresse': c.address || '',
                'Code postal': c.zip || '',
                'Ville': c.city || ''
            }));
            const ws2 = XLSX.utils.json_to_sheet(clientsData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Clients');
            
            // Products sheet
            const productsData = data.products.map(p => ({
                'Rfrence': p.ref,
                'Nom': p.name,
                'Prix HT': p.price,
                'TVA': p.vat
            }));
            const ws3 = XLSX.utils.json_to_sheet(productsData);
            XLSX.utils.book_append_sheet(wb, ws3, 'Produits');
            
            XLSX.writeFile(wb, `rapport-complet-${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Rapport complet export', 'success');
        }
        
        function downloadCSV(content, filename) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========== PHONE / CALL SYSTEM ==========
        let currentDialNumber = '';
        let callLog = [];
        let quickContactFilter = 'all';
        
        function initCallLog() {
            const saved = localStorage.getItem('avaCallLog');
            if (saved) {
                callLog = JSON.parse(saved);
            }
        }
        
        function saveCallLog() {
            localStorage.setItem('avaCallLog', JSON.stringify(callLog));
        }
        
        function dialKey(key) {
            if (key === '0' && currentDialNumber === '') {
                currentDialNumber = '+';
            } else {
                currentDialNumber += key;
            }
            updatePhoneDisplay();
        }
        
        function clearDialer() {
            currentDialNumber = '';
            updatePhoneDisplay();
        }
        
        function updatePhoneDisplay() {
            const display = document.getElementById('phone-display');
            const contactMatch = document.getElementById('phone-contact-match');
            
            if (display) {
                display.textContent = currentDialNumber || '_';
            }
            
            if (contactMatch && currentDialNumber.length >= 3) {
                // Try to match contact
                const match = findContactByPhone(currentDialNumber);
                contactMatch.textContent = match ? match.name : '';
            } else if (contactMatch) {
                contactMatch.textContent = '';
            }
        }
        
        function findContactByPhone(phone) {
            const cleanPhone = phone.replace(/\s/g, '');
            
            // Search in clients
            const client = data.clients.find(c => {
                const clientPhone = (c.phone || '').replace(/\s/g, '');
                return clientPhone.includes(cleanPhone) || cleanPhone.includes(clientPhone);
            });
            if (client) return { name: client.name, type: 'client', data: client };
            
            // Search in prospects
            const prospect = (data.prospects || []).find(p => {
                const prospectPhone = (p.phone || '').replace(/\s/g, '');
                return prospectPhone.includes(cleanPhone) || cleanPhone.includes(prospectPhone);
            });
            if (prospect) return { name: prospect.name, type: 'prospect', data: prospect };
            
            return null;
        }
        
        function makeCall(phoneNumber = null) {
            const number = phoneNumber || currentDialNumber;
            if (!number) {
                showToast('Entrez un numro', 'error');
                return;
            }
            
            // Log the call
            const contact = findContactByPhone(number);
            addToCallLog(number, contact, 'outgoing');
            
            // Open tel: link
            window.open(`tel:${number}`, '_self');
            showToast('Appel en cours...', 'success');
        }
        
        function makeWhatsAppCall(phoneNumber = null) {
            let number = phoneNumber || currentDialNumber;
            if (!number) {
                showToast('Entrez un numro', 'error');
                return;
            }
            
            // Format for WhatsApp (remove spaces, add country code if needed)
            number = number.replace(/\s/g, '').replace(/^0/, '33');
            if (!number.startsWith('+')) {
                number = '+' + number;
            }
            
            // Log the call
            const contact = findContactByPhone(phoneNumber || currentDialNumber);
            addToCallLog(phoneNumber || currentDialNumber, contact, 'whatsapp');
            
            // Open WhatsApp
            window.open(`https://wa.me/${number.replace('+', '')}`, '_blank');
            showToast('Ouverture de WhatsApp...', 'success');
        }
        
        function addToCallLog(number, contact, type) {
            callLog.unshift({
                id: Date.now(),
                number: number,
                contactName: contact?.name || null,
                contactType: contact?.type || null,
                type: type, // outgoing, incoming, missed, whatsapp
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 50 calls
            if (callLog.length > 50) {
                callLog = callLog.slice(0, 50);
            }
            
            saveCallLog();
            renderCallLog();
        }
        
        function renderCallLog() {
            const container = document.getElementById('call-log');
            if (!container) return;
            
            if (callLog.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun appel rcent</p>';
                return;
            }
            
            container.innerHTML = callLog.slice(0, 20).map(call => {
                const initials = call.contactName ? call.contactName.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase() : '?';
                const time = formatCallTime(call.timestamp);
                const typeIcon = getCallTypeIcon(call.type);
                const typeClass = call.type === 'missed' ? 'missed' : (call.type === 'whatsapp' ? 'outgoing' : 'outgoing');
                
                return `
                    <div class="call-log-item" onclick="quickDial('${call.number}')">
                        <div class="call-log-avatar">${initials}</div>
                        <div class="call-log-info">
                            <div class="call-log-name">${call.contactName || 'Inconnu'}</div>
                            <div class="call-log-number">${call.number}</div>
                        </div>
                        <div class="call-log-meta">
                            <div class="call-log-time">${time}</div>
                            <div class="call-log-type ${typeClass}">
                                ${typeIcon}
                                ${call.type === 'whatsapp' ? 'WhatsApp' : (call.type === 'outgoing' ? 'Sortant' : (call.type === 'incoming' ? 'Entrant' : 'Manqu'))}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getCallTypeIcon(type) {
            switch(type) {
                case 'outgoing':
                    return '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="7" y1="17" x2="17" y2="7"/><polyline points="7 7 17 7 17 17"/></svg>';
                case 'incoming':
                    return '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="17" y1="7" x2="7" y2="17"/><polyline points="17 17 7 17 7 7"/></svg>';
                case 'missed':
                    return '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
                case 'whatsapp':
                    return '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/></svg>';
                default:
                    return '';
            }
        }
        
        function formatCallTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return ' l\'instant';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} min`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h`;
            if (diff < 604800000) return date.toLocaleDateString('fr-FR', { weekday: 'short' });
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }
        
        function quickDial(number) {
            currentDialNumber = number;
            updatePhoneDisplay();
        }
        
        function clearCallLog() {
            if (confirm('Effacer tout l\'historique d\'appels ?')) {
                callLog = [];
                saveCallLog();
                renderCallLog();
                showToast('Historique effac', 'success');
            }
        }
        
        function filterQuickContacts(filter) {
            quickContactFilter = filter;
            
            // Update active button
            document.querySelectorAll('#quick-contact-filters .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(`filter-${filter}`);
            if (activeBtn) activeBtn.classList.add('active');
            
            renderQuickContacts();
        }
        
        function renderQuickContacts() {
            const container = document.getElementById('quick-contacts');
            if (!container) return;
            
            let contacts = [];
            
            // Add clients
            if (quickContactFilter === 'all' || quickContactFilter === 'clients') {
                data.clients.filter(c => c.phone).forEach(c => {
                    contacts.push({
                        name: c.name,
                        phone: c.phone,
                        type: 'client',
                        email: c.email
                    });
                });
            }
            
            // Add prospects
            if (quickContactFilter === 'all' || quickContactFilter === 'prospects') {
                (data.prospects || []).filter(p => p.phone).forEach(p => {
                    contacts.push({
                        name: p.name,
                        phone: p.phone,
                        type: 'prospect',
                        email: p.email,
                        contact: p.contact
                    });
                });
            }
            
            if (contacts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun contact avec numro de tlphone</p>';
                return;
            }
            
            contacts.sort((a, b) => a.name.localeCompare(b.name));
            
            container.innerHTML = contacts.map(c => {
                const initials = c.name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                const bgColor = c.type === 'client' ? 'var(--apple-blue), var(--apple-green)' : 'var(--apple-purple), var(--apple-orange)';
                
                return `
                    <div class="call-log-item">
                        <div class="call-log-avatar" style="background: linear-gradient(135deg, ${bgColor});">${initials}</div>
                        <div class="call-log-info">
                            <div class="call-log-name">${c.name}</div>
                            <div class="call-log-number">${c.phone}${c.contact ? '  ' + c.contact : ''}</div>
                        </div>
                        <div class="contact-actions">
                            <button class="quick-call-btn phone" onclick="event.stopPropagation(); callContact('${c.phone}')" title="Appeler">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                </svg>
                            </button>
                            <button class="quick-call-btn whatsapp" onclick="event.stopPropagation(); whatsappContact('${c.phone}')" title="WhatsApp">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function callContact(phone) {
            makeCall(phone);
        }
        
        function whatsappContact(phone) {
            makeWhatsAppCall(phone);
        }
        
        function renderPhonePage() {
            initCallLog();
            renderCallLog();
            renderQuickContacts();
            clearDialer();
        }

        // ========== THEME TOGGLE ==========
        function toggleTheme() {
            const html = document.documentElement;
            const track = document.getElementById('theme-toggle-track');
            const isDark = html.getAttribute('data-theme') === 'dark';
            
            if (isDark) {
                html.removeAttribute('data-theme');
                track.classList.remove('active');
                localStorage.setItem('avaTheme', 'light');
            } else {
                html.setAttribute('data-theme', 'dark');
                track.classList.add('active');
                localStorage.setItem('avaTheme', 'dark');
            }
        }
        
        function loadTheme() {
            const savedTheme = localStorage.getItem('avaTheme');
            const track = document.getElementById('theme-toggle-track');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                if (track) track.classList.add('active');
            }
        }
        
        // ========== GLOBAL SEARCH ==========
        let searchTimeout = null;
        
        function handleGlobalSearch(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => performSearch(query), 200);
        }
        
        function performSearch(query) {
            const resultsDiv = document.getElementById('search-results');
            if (!query || query.length < 2) {
                resultsDiv.classList.remove('show');
                return;
            }
            
            query = query.toLowerCase();
            let html = '';
            
            // Search invoices
            const invoices = data.invoices.filter(i => 
                i.number.toLowerCase().includes(query) ||
                (data.clients.find(c => c.id === i.clientId)?.name || '').toLowerCase().includes(query)
            ).slice(0, 3);
            
            if (invoices.length > 0) {
                html += `<div class="search-result-group">
                    <div class="search-result-title">Factures</div>
                    ${invoices.map(inv => {
                        const client = data.clients.find(c => c.id === inv.clientId);
                        return `<div class="search-result-item" onmousedown="navigateTo('factures'); previewInvoice(${inv.id});">
                            <div class="search-result-icon" style="background: var(--apple-blue);">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>
                            </div>
                            <div class="search-result-info">
                                <div class="search-result-name">${inv.number}</div>
                                <div class="search-result-meta">${client?.name || 'Client inconnu'} - ${inv.total.toFixed(2)}</div>
                            </div>
                        </div>`;
                    }).join('')}
                </div>`;
            }
            
            // Search clients
            const clients = data.clients.filter(c => 
                c.name.toLowerCase().includes(query) ||
                (c.email || '').toLowerCase().includes(query)
            ).slice(0, 3);
            
            if (clients.length > 0) {
                html += `<div class="search-result-group">
                    <div class="search-result-title">Clients</div>
                    ${clients.map(c => `<div class="search-result-item" onmousedown="navigateTo('clients'); editClient(${c.id});">
                        <div class="search-result-icon" style="background: var(--apple-green);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                        </div>
                        <div class="search-result-info">
                            <div class="search-result-name">${c.name}</div>
                            <div class="search-result-meta">${c.email || 'Pas d\'email'}</div>
                        </div>
                    </div>`).join('')}
                </div>`;
            }
            
            // Search products
            const products = data.products.filter(p => 
                p.name.toLowerCase().includes(query) ||
                p.ref.toLowerCase().includes(query)
            ).slice(0, 3);
            
            if (products.length > 0) {
                html += `<div class="search-result-group">
                    <div class="search-result-title">Produits</div>
                    ${products.map(p => `<div class="search-result-item" onmousedown="navigateTo('produits');">
                        <div class="search-result-icon" style="background: var(--apple-purple);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                        </div>
                        <div class="search-result-info">
                            <div class="search-result-name">${p.name}</div>
                            <div class="search-result-meta">${p.ref} - ${p.price.toFixed(2)}</div>
                        </div>
                    </div>`).join('')}
                </div>`;
            }
            
            // Search prospects
            const prospects = (data.prospects || []).filter(p => 
                p.name.toLowerCase().includes(query) ||
                (p.contact || '').toLowerCase().includes(query) ||
                (p.email || '').toLowerCase().includes(query)
            ).slice(0, 3);
            
            if (prospects.length > 0) {
                html += `<div class="search-result-group">
                    <div class="search-result-title">Prospects</div>
                    ${prospects.map(p => `<div class="search-result-item" onmousedown="navigateTo('prospection'); editProspect(${p.id});">
                        <div class="search-result-icon" style="background: var(--apple-orange);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                        </div>
                        <div class="search-result-info">
                            <div class="search-result-name">${p.name}</div>
                            <div class="search-result-meta">${p.contact || p.email || 'Pas de contact'}</div>
                        </div>
                    </div>`).join('')}
                </div>`;
            }
            
            if (html === '') {
                html = `<div class="search-result-group">
                    <div class="search-result-item">
                        <div class="search-result-info">
                            <div class="search-result-name" style="color: var(--text-secondary);">Aucun rsultat pour "${query}"</div>
                        </div>
                    </div>
                </div>`;
            }
            
            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('show');
        }
        
        function showSearchResults() {
            const query = document.getElementById('global-search').value;
            if (query.length >= 2) {
                document.getElementById('search-results').classList.add('show');
            }
        }
        
        function hideSearchResults() {
            setTimeout(() => {
                document.getElementById('search-results').classList.remove('show');
            }, 200);
        }

        // ========== DEVELOPER MODE & MODULES ==========
        let logoClickCount = 0;
        let logoClickTimer = null;
        
        // Default module states
        const defaultModules = {
            phone: true,
            prospection: true,
            calendrier: true,
            rapports: true
        };
        
        let modules = { ...defaultModules };
        
        function handleLogoClick() {
            logoClickCount++;
            
            // Reset counter after 2 seconds of inactivity
            clearTimeout(logoClickTimer);
            logoClickTimer = setTimeout(() => {
                logoClickCount = 0;
            }, 2000);
            
            // Open dev panel after 5 clicks
            if (logoClickCount >= 5) {
                logoClickCount = 0;
                openDevPanel();
            }
        }
        
        function openDevPanel() {
            loadModules();
            updateModuleToggles();
            document.getElementById('dev-panel-overlay').classList.add('active');
        }
        
        function closeDevPanel(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('dev-panel-overlay').classList.remove('active');
        }
        
        function loadModules() {
            const saved = localStorage.getItem('avaModules');
            if (saved) {
                modules = { ...defaultModules, ...JSON.parse(saved) };
            }
        }
        
        function saveModules() {
            localStorage.setItem('avaModules', JSON.stringify(modules));
        }
        
        function toggleModule(moduleName) {
            modules[moduleName] = !modules[moduleName];
            saveModules();
            updateModuleToggles();
            applyModuleStates();
            showToast(`Module ${getModuleLabel(moduleName)} ${modules[moduleName] ? 'activ' : 'dsactiv'}`, 'success');
        }
        
        function getModuleLabel(moduleName) {
            const labels = {
                phone: 'Tlphone',
                prospection: 'Prospection',
                calendrier: 'Calendrier',
                rapports: 'Rapports'
            };
            return labels[moduleName] || moduleName;
        }
        
        function updateModuleToggles() {
            Object.keys(modules).forEach(moduleName => {
                const toggle = document.getElementById(`module-${moduleName}-toggle`);
                if (toggle) {
                    if (modules[moduleName]) {
                        toggle.classList.add('active');
                    } else {
                        toggle.classList.remove('active');
                    }
                }
            });
        }
        
        function applyModuleStates() {
            // Phone module
            const phoneNav = document.querySelector('[data-page="telephone"]');
            const phonePage = document.getElementById('page-telephone');
            const phoneCallBtns = document.querySelectorAll('.phone-call-action');
            
            if (phoneNav) phoneNav.style.display = modules.phone ? 'flex' : 'none';
            if (phonePage) phonePage.style.display = modules.phone ? '' : 'none';
            
            // Hide/show call buttons in client and prospect lists
            document.querySelectorAll('[onclick*="callContact"], [onclick*="whatsappContact"]').forEach(btn => {
                btn.style.display = modules.phone ? '' : 'none';
            });
            
            // Prospection module
            const prospectionNav = document.querySelector('[data-page="prospection"]');
            const prospectionPage = document.getElementById('page-prospection');
            
            if (prospectionNav) prospectionNav.style.display = modules.prospection ? 'flex' : 'none';
            if (prospectionPage) prospectionPage.style.display = modules.prospection ? '' : 'none';
            
            // Calendrier module
            const calendrierNav = document.querySelector('[data-page="calendrier"]');
            const calendrierPage = document.getElementById('page-calendrier');
            
            if (calendrierNav) calendrierNav.style.display = modules.calendrier ? 'flex' : 'none';
            if (calendrierPage) calendrierPage.style.display = modules.calendrier ? '' : 'none';
            
            // Rapports module
            const rapportsNav = document.querySelector('[data-page="rapports"]');
            const rapportsPage = document.getElementById('page-rapports');
            
            if (rapportsNav) rapportsNav.style.display = modules.rapports ? 'flex' : 'none';
            if (rapportsPage) rapportsPage.style.display = modules.rapports ? '' : 'none';
            
            // If current page is disabled, go to dashboard
            const currentPage = document.querySelector('.nav-item.active')?.dataset?.page;
            if (currentPage && !modules[currentPage] && ['phone', 'telephone', 'prospection', 'calendrier', 'rapports'].includes(currentPage)) {
                navigateTo('dashboard');
            }
            
            // Refresh clients and prospects to update call buttons
            if (typeof renderAllClients === 'function' && document.getElementById('all-clients')) {
                renderAllClients();
            }
            if (typeof renderAllProspects === 'function' && document.getElementById('all-prospects')) {
                renderAllProspects();
            }
        }
        
        function initModules() {
            loadModules();
            applyModuleStates();
        }

        // ========== INIT ==========
        loadTheme();
        initModules();
        checkSession();
    </script>
</body>
</html>
